<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Umamusume Race Tracker</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151924; --soft:#1b2030; --muted:#9aa4b2;
    --text:#e7ecf3; --acc:#5aa7ff; --good:#45d48a; --bad:#ff7a7a; --line:#23283a; --warn:#ffb454;
    --winRow:#2b2405; --winRowBorder:#8a6d0a;
    --lossRow:#2b0f12; --lossRowBorder:#8a1f2a;
    --focusRow:#0f2b1c; --focusBorder:#2aa759;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0 0 10px 0;font-size:16px}

  .controls{display:grid;grid-template-columns:minmax(220px,260px) 1fr auto;gap:10px;align-items:end;width:100%}
  .ctrl{display:flex;flex-direction:column;gap:4px}
  .ctrl .label{font-size:12px;color:var(--muted)}
  .grow input{width:100%}

  select, input, button, textarea{background:var(--soft);color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  button.primary{background:var(--acc);border-color:transparent;color:#041a2e}
  .iconbtn{padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:var(--soft);color:var(--text)}

  .wrap{padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px}
  .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px;color:var(--muted)}
  .panel .body{padding:12px 14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}

  .toolbar{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:10px}
  .toolbox{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px}
  .toolbox h3{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
  .tools-grid{display:grid;grid-template-columns:repeat(4, minmax(110px,1fr));gap:8px}
  .checkgroup{display:flex;flex-wrap:wrap;gap:10px 12px;background:#12182a;border:1px solid var(--line);border-radius:8px;padding:8px}
  .tools-actions{display:flex;gap:8px;align-items:center;margin-top:8px}

  table{width:100%;border-collapse:collapse;font-size:13px}
  th, td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
  th{position:sticky;top:0;background:linear-gradient(#151924,#141824);z-index:1;user-select:none}
  th.sortable{cursor:pointer}
  tr:hover td{background:#131826}

  tr.win td{background:var(--winRow)}
  tr.win td:first-child{border-left:2px solid var(--winRowBorder)}
  tr.loss td{background:var(--lossRow)}
  tr.loss td:first-child{border-left:2px solid var(--lossRowBorder)}
  tr.focus td{background:var(--focusRow)}
  tr.focus td:first-child{border-left:2px solid var(--focusBorder)}

  .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:2px;border:1px solid var(--line)}
  .dot.win{background:linear-gradient(180deg,#f2d85c,#b89415);border-color:#b89415}
  .dot.loss{background:#c43d3d;border-color:#c43d3d}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .card{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px}
  .card strong{display:block;font-size:18px;margin-bottom:2px}
  .pill{display:inline-block;font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
  .subtle{color:var(--muted);font-size:12px}
  .warn-text{color:var(--warn)}
  .info-grid{display:grid;grid-template-columns:1fr;gap:8px}
  .info-item{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px}
  .info-item h3{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
  .list{margin:0;padding-left:18px}
  .list li{margin:2px 0}

  dialog{border:1px solid var(--line);border-radius:12px;background:var(--panel);color:var(--text);padding:0;max-width:980px}
  dialog header{padding:12px 14px;border-bottom:1px solid var(--line)}
  dialog .body{padding:12px 14px}
  .filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  .selWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .box{border:1px solid var(--line);border-radius:10px;padding:10px;background:var(--soft);max-height:420px;overflow:auto}
  .item{display:flex;gap:8px;align-items:flex-start;justify-content:space-between;border-bottom:1px dashed #23283a;padding:6px 0}
  .item:last-child{border-bottom:0}
  .empty{color:var(--muted);font-size:12px;padding:6px 0}
  .sort-ind{font-size:11px;color:var(--muted)}

  .uma-photo{width:100%;height:200px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#0f1016;cursor:pointer}
  #photoDialog img{max-width:96vw;max-height:80vh;display:block}
  .good{color:#45d48a}.bad{color:#ff7a7a}

  .tmpl-title{font-size:12px;color:var(--muted);margin:8px 0 4px 0}
  .tmpl-items{display:flex;flex-direction:column;gap:6px;background:#12182a;border:1px solid var(--line);border-radius:8px;padding:8px}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .editor-section{border:1px solid var(--line);border-radius:10px;background:var(--soft);padding:10px;margin:8px 0}
  .editor-section h4{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
  .support-row,.skill-row{display:grid;grid-template-columns:120px 1fr auto;gap:8px;margin:6px 0}
  .support-row.fixed{grid-template-columns:120px 1fr}
  .mini{font-size:12px;color:var(--muted)}
  .inline-actions{display:flex;gap:6px;margin-top:6px}

  .calendar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .month{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:8px}
  .month h4{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
  .race-row{display:flex;flex-direction:column;gap:2px;padding:6px 0;border-bottom:1px dashed #23283a}
  .race-row:last-child{border-bottom:0}
  .rtitle{cursor:pointer;color:var(--text);text-decoration:underline}
  .rmeta{font-size:11px;color:var(--muted)}
  .tag-win{color:#45d48a;font-size:11px}
  .tag-loss{color:#ff7a7a;font-size:11px}
</style>
</head>
<body>
<header>
  <h1>Umamusume race tracker</h1>
  <div class="controls">
    <div class="ctrl">
      <span class="label">Umamusume</span>
      <select id="umaSelect"></select>
    </div>
    <div class="ctrl grow">
      <span class="label">Quick search</span>
      <input id="searchBox" placeholder="Search race, month, year" />
    </div>
    <div class="ctrl" style="align-items:flex-start">
      <button id="clearFilters">Clear filters</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Left -->
  <section class="panel">
    <h2>Umamusume details</h2>
    <div class="body">
      <div class="info-grid">
        <div class="info-item">
          <h3>Photo</h3>
          <img id="umaPhoto" class="uma-photo" alt="Umamusume photo (click to enlarge)" />
          <div class="subtle" style="margin-top:6px">JPG or PNG. Click the photo to enlarge. Upload in <em>Edit Umamusume details</em>.</div>
        </div>
        <div class="info-item"><h3>Pace aptitude</h3><div id="infoPace">None</div></div>
        <div class="info-item"><h3>Track aptitude</h3><div id="infoTrack">None</div></div>
        <div class="info-item"><h3>Distance aptitude</h3><div id="infoAptitude">None</div></div>
        <div class="info-item">
          <h3>Recommended support cards <span class="subtle">(6 total)</span></h3>
          <ul id="infoSupports" class="list"><li>None</li></ul>
          <div id="supportsWarn" class="warn-text" style="margin-top:6px;display:none">Exactly 6 cards are required. Open <em>Edit Umamusume details</em>.</div>
        </div>
        <div class="info-item"><h3>Alternative support cards</h3><ul id="infoAltSupports" class="list"><li>None</li></ul></div>
        <div class="info-item"><h3>Support deck notes</h3><div id="infoDeckNote">None</div></div>
        <div class="info-item"><h3>Recommended skills</h3><ul id="infoSkills" class="list"><li>None</li></ul></div>
      </div>
      <div class="row" style="margin-top:10px"><button id="editInfoBtn">Edit Umamusume details</button></div>
    </div>

    <h2>Data</h2>
    <div class="body">
      <div class="row">
        <button id="exportJson">Export progress</button>
        <button id="importJsonBtn">Import progress</button>
        <button id="clearUmaData" class="bad">Clear selected</button>
      </div>
      <input id="importFile" type="file" accept="application/json" hidden />
      <p class="subtle">Data saves in your browser per Umamusume.</p>
    </div>
  </section>

  <!-- Right -->
  <section class="panel">
    <h2>Dashboard</h2>
    <div class="body">
      <div class="toolbar">
        <div class="toolbox">
          <h3>Filters</h3>
          <div class="tools-grid">
            <div>
              <div class="subtle">View</div>
              <div class="checkgroup" id="dashView">
                <label><input type="radio" name="view" value="recommended" checked> Recommended</label>
                <label><input type="radio" name="view" value="mandatory"> Mandatory</label>
                <label><input type="radio" name="view" value="all"> All races</label>
                <label><input type="radio" name="view" value="calendar"> Calendar</label>
              </div>
            </div>

            <div>
              <div class="subtle">Grades</div>
              <div class="checkgroup" id="dashGrades">
                <label><input type="checkbox" value="G1"> G1</label>
                <label><input type="checkbox" value="G2"> G2</label>
                <label><input type="checkbox" value="G3"> G3</label>
              </div>
            </div>
            <div>
              <div class="subtle">Track</div>
              <div class="checkgroup" id="dashTracks">
                <label><input type="checkbox" value="Turf"> Turf</label>
                <label><input type="checkbox" value="Dirt"> Dirt</label>
              </div>
            </div>
            <div>
              <div class="subtle">Distance</div>
              <div class="checkgroup" id="dashDistances">
                <label><input type="checkbox" value="Sprint"> Sprint</label>
                <label><input type="checkbox" value="Mile"> Mile</label>
                <label><input type="checkbox" value="Medium"> Medium</label>
                <label><input type="checkbox" value="Long"> Long</label>
              </div>
            </div>
            <div>
              <div class="subtle">Year</div>
              <div class="checkgroup" id="dashYears">
                <label><input type="checkbox" value="Junior"> Junior</label>
                <label><input type="checkbox" value="Classic"> Classic</label>
                <label><input type="checkbox" value="Senior"> Senior</label>
              </div>
            </div>
            <div>
              <div class="subtle">Participation</div>
              <div class="checkgroup">
                <label><input type="checkbox" id="showParticipated"> All participated races</label>
              </div>
            </div>
          </div>
          <div class="tools-actions">
            <button id="clearEligibility">Clear tag filter</button>
            <span class="subtle">This also turns off any tag based filtering.</span>
          </div>
        </div>

        <div class="toolbox">
          <h3>Recommendations</h3>
          <div class="tools-actions">
            <button id="editRecsBtn">Edit recommended</button>
            <button id="editMandatoryBtn">Edit mandatory</button>
          </div>

          <div class="tmpl-title">Crown titles</div>
          <div id="crownList" class="tmpl-items"></div>
        </div>
      </div>

      <div class="stats">
        <div class="card"><strong id="statTotal">0</strong>Total races</div>
        <div class="card"><strong id="statWins" class="good">0</strong>Wins</div>
        <div class="card"><strong id="statLosses" class="bad">0</strong>Losses</div>
        <div class="card">
          <strong style="font-size:14px">Actions</strong>
          <div class="legend" style="margin-top:6px">
            <span class="chip"><span class="dot win"></span>Win</span>
            <span class="chip"><span class="dot loss"></span>Loss</span>
          </div>
          <div class="row" style="margin-top:8px;margin-bottom:0">
            <button id="resetMarks">Reset marks</button>
          </div>
        </div>
      </div>
    </div>

    <h2>Races <span id="viewBadge" class="pill">Recommended</span></h2>
    <div class="body">
      <table id="raceTable">
        <thead>
          <tr>
            <th style="width:130px">Date</th>
            <th class="sortable" data-sort="name">Race <span id="sortName" class="sort-ind"></span></th>
            <th style="width:210px">Details</th>
            <th class="sortable" data-sort="year" style="width:90px">Year <span id="sortYear" class="sort-ind"></span></th>
            <th style="width:220px">Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="tableHelp" class="subtle" style="margin-top:8px">Click the race or year header to sort. Click again to toggle direction.</p>

      <div id="calendarWrap" class="calendar" style="display:none"></div>
      <p id="calHelp" class="subtle" style="margin-top:8px;display:none">Click a race title to add it to Recommended or Mandatory.</p>
    </div>
  </section>
</div>

<!-- Editor for recommended / mandatory -->
<dialog id="recEditor">
  <header><strong id="editorTitle">Edit recommended races</strong></header>
  <div class="body">
    <div class="filters" style="align-items:flex-end">
      <label style="flex:2;min-width:220px">Search<br/><input id="raceSearch" placeholder="Search name or month" /></label>
      <div><div class="subtle">Year</div><select id="filterYear"><option value="">All</option><option>Junior</option><option>Classic</option><option>Senior</option></select></div>
      <div><div class="subtle">Grades</div><div class="checkgroup" id="filterGrades">
        <label><input type="checkbox" value="G1"> G1</label>
        <label><input type="checkbox" value="G2"> G2</label>
        <label><input type="checkbox" value="G3"> G3</label>
      </div></div>
      <div><div class="subtle">Distance</div><div class="checkgroup" id="filterDistances">
        <label><input type="checkbox" value="Sprint"> Sprint</label>
        <label><input type="checkbox" value="Mile"> Mile</label>
        <label><input type="checkbox" value="Medium"> Medium</label>
        <label><input type="checkbox" value="Long"> Long</label>
      </div></div>
      <div><div class="subtle">Track</div><div class="checkgroup" id="filterTracks">
        <label><input type="checkbox" value="Turf"> Turf</label>
        <label><input type="checkbox" value="Dirt"> Dirt</label>
      </div></div>
    </div>

    <div class="selWrap">
      <div class="box"><div class="subtle" style="margin-bottom:6px">Matches</div><div id="raceResults"></div></div>
      <div class="box"><div class="subtle" style="margin-bottom:6px">Selected</div><div id="selectedRaces"></div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="recSave" class="primary">Save</button>
      <button id="recCancel">Cancel</button>
    </div>
  </div>
</dialog>

<!-- Photo lightbox -->
<dialog id="photoDialog">
  <header><strong>Umamusume photo</strong></header>
  <div class="body">
    <img id="photoLarge" alt="Umamusume photo" />
    <div class="row" style="margin-top:10px"><button id="photoClose">Close</button></div>
  </div>
</dialog>

<!-- Full Umamusume details editor -->
<dialog id="infoEditor">
  <header><strong>Edit Umamusume details</strong></header>
  <div class="body">
    <div class="editor-section">
      <h4>Photo</h4>
      <div class="row">
        <input id="photoInput" type="file" accept="image/*" />
        <button id="photoRemoveBtn" class="iconbtn">Remove photo</button>
      </div>
      <div class="mini">Photo saves as soon as you pick a file.</div>
    </div>

    <div class="editor-section">
      <h4>Pace aptitude</h4>
      <div class="checkgroup" id="editPace">
        <label><input type="checkbox" value="Front Runner"> Front Runner</label>
        <label><input type="checkbox" value="Pace Chaser"> Pace Chaser</label>
        <label><input type="checkbox" value="Late Surger"> Late Surger</label>
        <label><input type="checkbox" value="End Closer"> End Closer</label>
      </div>
      <div class="mini">You can select multiple. Pace is not used to filter recommended.</div>
    </div>

    <div class="editor-section">
      <h4>Track aptitude</h4>
      <div class="grid-2">
        <label>Turf
          <select id="editTurf"></select>
        </label>
        <label>Dirt
          <select id="editDirt"></select>
        </label>
      </div>
    </div>

    <div class="editor-section">
      <h4>Distance aptitude</h4>
      <div class="grid-4">
        <label>Sprint
          <select id="editSprint"></select>
        </label>
        <label>Mile
          <select id="editMile"></select>
        </label>
        <label>Medium
          <select id="editMedium"></select>
        </label>
        <label>Long
          <select id="editLong"></select>
        </label>
      </div>
    </div>

    <div class="editor-section">
      <h4>Recommended support cards <span class="mini">(exactly 6)</span></h4>
      <div id="editSupports"></div>
    </div>

    <div class="editor-section">
      <h4>Alternative support cards</h4>
      <div id="editAltSupports"></div>
      <div class="row"><button id="addAltSupport" class="iconbtn">+ Add alternative</button></div>
    </div>

    <div class="editor-section">
      <h4>Recommended skills</h4>
      <div id="editSkills"></div>
      <div class="row"><button id="addSkill" class="iconbtn">+ Add skill</button></div>
    </div>

    <div class="editor-section">
      <h4>Support deck notes</h4>
      <textarea id="editDeckNote" rows="4" placeholder="Notes about deck composition, variations, and reasoning"></textarea>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="infoSave" class="primary">Save</button>
      <button id="infoClose" class="iconbtn">Close</button>
    </div>
  </div>
</dialog>

<!-- Add-to-list chooser -->
<dialog id="addToListDialog">
  <header><strong id="addTitle">Add race</strong></header>
  <div class="body">
    <div id="addRaceMeta" class="subtle"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnAddRec" class="iconbtn">Add to Recommended</button>
      <button id="btnAddMand" class="iconbtn">Add to Mandatory</button>
      <button id="btnAddCancel">Cancel</button>
    </div>
  </div>
</dialog>

<script>
/* ===== Race data =====
   Game8-aligned names and fixes.
*/
const RACES_JUNIOR = [
  {date:'Late Jul',  year:'Junior', name:'Hakodate Junior Stakes',        grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Aug',  year:'Junior', name:'Niigata Junior Stakes',         grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Aug',  year:'Junior', name:'Sapporo Junior Stakes',         grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Sep', year:'Junior', name:'Kokura Junior Stakes',          grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Oct', year:'Junior', name:'Saudi Arabia Royal Cup',        grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Oct',  year:'Junior', name:'Artemis Stakes',                grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Nov', year:'Junior', name:'Keio Hai Junior Stakes',        grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Nov', year:'Junior', name:'Daily Hai Junior Stakes',       grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Nov',  year:'Junior', name:'Tokyo Sports Hai Junior Stakes',grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Nov',  year:'Junior', name:'Kyoto Junior Stakes',           grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Junior', name:'Hanshin Juvenile Fillies',      grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Early Dec', year:'Junior', name:'Asahi Hai Futurity Stakes',     grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Late Dec',  year:'Junior', name:'Hopeful Stakes',                grade:'G1', distance:'Medium', track:'Turf'}
];

const RACES_CLASSIC = [
  {date:'Early Jan', year:'Classic', name:'Shinzan Kinen',             grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Jan', year:'Classic', name:'Fairy Stakes',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Jan', year:'Classic', name:'Keisei Hai',                grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Feb', year:'Classic', name:'Kisaragi Sho',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Feb', year:'Classic', name:'Queen Cup',                 grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Feb', year:'Classic', name:'Kyodo News Hai',            grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Mar', year:'Classic', name:'Yayoi Sho',                 grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Mar', year:'Classic', name:'Filliesâ€™ Revue',            grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Mar', year:'Classic', name:'Tulip Sho',                 grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Spring Stakes',             grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Mainichi Hai',              grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Falcon Stakes',             grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Flower Cup',                grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'Satsuki Sho',               grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'Oka Sho',                   grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'New Zealand Trophy',        grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'Arlington Cup',             grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Apr',  year:'Classic', name:'Flora Stakes',              grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Apr',  year:'Classic', name:'Aoba Sho',                  grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early May', year:'Classic', name:'NHK Mile Cup',              grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Early May', year:'Classic', name:'Kyoto Shimbun Hai',         grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Classic', name:'Japanese Derby (Tokyo Yushun)', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Classic', name:'Japanese Oaks',             grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Classic', name:'Aoi Stakes',                grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Yasuda Kinen',              grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Epsom Cup',                 grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Naruo Kinen',               grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Mermaid Stakes',            grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jun',  year:'Classic', name:'Takarazuka Kinen',          grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Jun',  year:'Classic', name:'Unicorn Stakes',            grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Late Jun',  year:'Classic', name:'Hakodate Sprint Stakes',    grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'Japan Dirt Derby',          grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Early Jul', year:'Classic', name:'Radio Nikkei Sho',          grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'CBC Sho',                   grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'Procyon Stakes',            grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Mid Jul',   year:'Classic', name:'Tanabata Sho',              grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Mid Jul',   year:'Classic', name:'Hakodate Kinen',            grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jul',  year:'Classic', name:'Queen Stakes',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Jul',  year:'Classic', name:'Chukyo Kinen',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Jul',  year:'Classic', name:'Ibis Summer Dash',          grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Aug', year:'Classic', name:'Leopard Stakes',            grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Early Aug', year:'Classic', name:'Kokura Kinen',              grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Mid Aug',   year:'Classic', name:'Sekiya Kinen',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Mid Aug',   year:'Classic', name:'Elm Stakes',                grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Mid Aug',   year:'Classic', name:'Sapporo Kinen',             grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Mid Aug',   year:'Classic', name:'Kitakyushu Kinen',          grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Aug',  year:'Classic', name:'Keeneland Cup',             grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Rose Stakes',               grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Centaur Stakes',            grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Niigata Kinen',             grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Keisei Hai Autumn Handicap',grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Mid Sep',   year:'Classic', name:'Shion Stakes',              grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'Sprinters Stakes',          grade:'G1', distance:'Sprint', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'St. Lite Kinen',            grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'Kobe Shimbun Hai',          grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'All Comers',                grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'Sirius Stakes',             grade:'G3', distance:'Medium', track:'Dirt'},
  {date:'Early Oct', year:'Classic', name:'Kyoto Daishoten',           grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Oct', year:'Classic', name:'Mainichi Okan',             grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Early Oct', year:'Classic', name:'Fuchu Umamusume Stakes',    grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Tenno Sho (Autumn)',        grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Kikuka Sho',                grade:'G1', distance:'Long',   track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Shuka Sho',                 grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Fuji Stakes',               grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Swan Stakes',               grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Nov', year:'Classic', name:'JBC Classic',               grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'JBC Sprint',                grade:'G1', distance:'Sprint', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:"JBC Ladies' Classic",       grade:'G1', distance:'Mile',   track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'Queen Elizabeth II Cup',    grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Early Nov', year:'Classic', name:'Copa Republica Argentina',  grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Early Nov', year:'Classic', name:'Miyako Stakes',             grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'Musashino Stakes',          grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Mid Nov',   year:'Classic', name:'Fukushima Kinen',           grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Classic', name:'Japan Cup',                 grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Classic', name:'Mile Championship',         grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Late Nov',  year:'Classic', name:'Keihan Hai',                grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Champions Cup',             grade:'G1', distance:'Mile',   track:'Dirt'},
  {date:'Early Dec', year:'Classic', name:'Stayers Stakes',            grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Challenge Cup',             grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Chunichi Shimbun Hai',      grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Mid Dec',   year:'Classic', name:'Capella Stakes',            grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Mid Dec',   year:'Classic', name:'Turquoise Stakes',          grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Dec',  year:'Classic', name:'Tokyo Daishoten',           grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Late Dec',  year:'Classic', name:'Arima Kinen',               grade:'G1', distance:'Long',   track:'Turf'},
  {date:'Late Dec',  year:'Classic', name:'Hanshin Cup',               grade:'G2', distance:'Sprint', track:'Turf'}
];

const RACES_SENIOR = [
  {date:'Early Jan', year:'Senior', name:'Nikkei Shinshun Hai',       grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Jan', year:'Senior', name:'Kyoto Kimpai',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Jan', year:'Senior', name:'Nakayama Kimpai',           grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jan', year:'Senior', name:'Aichi Hai',                 grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jan',  year:'Senior', name:'Tokai Stakes',              grade:'G2', distance:'Mile',   track:'Dirt'},
  {date:'Late Jan',  year:'Senior', name:'American JCC',              grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Jan',  year:'Senior', name:'Silk Road Stakes',          grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Jan',  year:'Senior', name:'Negishi Stakes',            grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Feb', year:'Senior', name:'Kyoto Kinen',               grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Feb', year:'Senior', name:'Tokyo Shimbun Hai',         grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'February Stakes',           grade:'G1', distance:'Mile',   track:'Dirt'},
  {date:'Late Feb',  year:'Senior', name:'Nakayama Kinen',            grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Kyoto Umamusume Stakes',    grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Diamond Stakes',            grade:'G3', distance:'Long',   track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Kokura Daishoten',          grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Hankyu Hai',                grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Mar', year:'Senior', name:'Kinko Sho',                 grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Mar', year:'Senior', name:'Ocean Stakes',              grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Mar', year:'Senior', name:'Nakayama Umamusume Stakes', grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Osaka Hai',                 grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Takamatsunomiya Kinen',     grade:'G1', distance:'Sprint', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Nikkei Sho',                grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Hanshin Daishoten',         grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'March Stakes',              grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Early Apr', year:'Senior', name:'Hanshin Umamusume Stakes',  grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Early Apr', year:'Senior', name:'Lord Derby Challenge Trophy',grade:'G3', distance:'Mile',  track:'Turf'},
  {date:'Early Apr', year:'Senior', name:'Antares Stakes',            grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Late Apr',  year:'Senior', name:'Tenno Sho (Spring)',        grade:'G1', distance:'Long',   track:'Turf'},
  {date:'Late Apr',  year:'Senior', name:'Milers Cup',                grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Apr',  year:'Senior', name:'Fukushima Umamusume Stakes',grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early May', year:'Senior', name:'Victoria Mile',             grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Early May', year:'Senior', name:'Keio Hai Spring Cup',       grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early May', year:'Senior', name:'Niigata Daishoten',         grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Senior', name:'Meguro Kinen',              grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Late May',  year:'Senior', name:'Heian Stakes',              grade:'G3', distance:'Medium', track:'Dirt'},
  {date:'Early Jun', year:'Senior', name:'Yasuda Kinen',              grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Early Jun', year:'Senior', name:'Naruo Kinen',               grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jun', year:'Senior', name:'Mermaid Stakes',            grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jun', year:'Senior', name:'Epsom Cup',                 grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Jun',  year:'Senior', name:'Teio Sho',                  grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Late Jun',  year:'Senior', name:'Takarazuka Kinen',          grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Jun',  year:'Senior', name:'Hakodate Sprint Stakes',    grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Senior', name:'CBC Sho',                   grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Senior', name:'Procyon Stakes',            grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Jul', year:'Senior', name:'Tanabata Sho',              grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jul', year:'Senior', name:'Hakodate Kinen',            grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jul',  year:'Senior', name:'Chukyo Kinen',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Jul',  year:'Senior', name:'Ibis Summer Dash',          grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Jul',  year:'Senior', name:'Queen Stakes',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Aug', year:'Senior', name:'Kokura Kinen',              grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Aug', year:'Senior', name:'Sekiya Kinen',              grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Early Aug', year:'Senior', name:'Elm Stakes',                grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Late Aug',  year:'Senior', name:'Sapporo Kinen',             grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Aug',  year:'Senior', name:'Kitakyushu Kinen',          grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Aug',  year:'Senior', name:'Keeneland Cup',             grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Senior', name:'Centaur Stakes',            grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Senior', name:'Niigata Kinen',             grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Sep', year:'Senior', name:'Keisei Hai Autumn Handicap',grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Sep',  year:'Senior', name:'Sprinters Stakes',          grade:'G1', distance:'Sprint', track:'Turf'},
  {date:'Late Sep',  year:'Senior', name:'All Comers',                grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Senior', name:'Sirius Stakes',             grade:'G3', distance:'Medium', track:'Dirt'},
  {date:'Early Oct', year:'Senior', name:'Kyoto Daishoten',           grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Oct', year:'Senior', name:'Mainichi Okan',             grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Early Oct', year:'Senior', name:'Fuchu Umamusume Stakes',    grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Late Oct',  year:'Senior', name:'Tenno Sho (Autumn)',        grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Oct',  year:'Senior', name:'Swan Stakes',               grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Late Oct',  year:'Senior', name:'Fuji Stakes',               grade:'G2', distance:'Mile',   track:'Turf'},
  {date:'Early Nov', year:'Senior', name:'JBC Classic',               grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'JBC Sprint',                grade:'G1', distance:'Sprint', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:"JBC Ladies' Classic",       grade:'G1', distance:'Mile',   track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'Queen Elizabeth II Cup',    grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Early Nov', year:'Senior', name:'Copa Republica Argentina',  grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Early Nov', year:'Senior', name:'Miyako Stakes',             grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'Musashino Stakes',          grade:'G3', distance:'Mile',   track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'Fukushima Kinen',           grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Senior', name:'Japan Cup',                 grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Senior', name:'Mile Championship',         grade:'G1', distance:'Mile',   track:'Turf'},
  {date:'Late Nov',  year:'Senior', name:'Keihan Hai',                grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Champions Cup',             grade:'G1', distance:'Mile',   track:'Dirt'},
  {date:'Early Dec', year:'Senior', name:'Stayers Stakes',            grade:'G2', distance:'Long',   track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Challenge Cup',             grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Chunichi Shimbun Hai',      grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Capella Stakes',            grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Dec', year:'Senior', name:'Turquoise Stakes',          grade:'G3', distance:'Mile',   track:'Turf'},
  {date:'Late Dec',  year:'Senior', name:'Tokyo Daishoten',           grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Late Dec',  year:'Senior', name:'Arima Kinen',               grade:'G1', distance:'Long',   track:'Turf'},
  {date:'Late Dec',  year:'Senior', name:'Hanshin Cup',               grade:'G2', distance:'Sprint', track:'Turf'}
];

const RACES=[...RACES_JUNIOR,...RACES_CLASSIC,...RACES_SENIOR];

/* ===== Crown titles ===== */
const CROWNS = [
  {id:'classic_triple', title:'Classic Triple Crown', keys:[
    "Classic__Early Apr__Satsuki Sho",
    "Classic__Late May__Japanese Derby (Tokyo Yushun)",
    "Classic__Late Oct__Kikuka Sho"
  ]},
  {id:'triple_tiara', title:'Triple Tiara', keys:[
    "Classic__Early Apr__Oka Sho",
    "Classic__Late May__Japanese Oaks",
    "Classic__Late Oct__Shuka Sho"
  ]},
  {id:'spring_triple', title:'Senior Spring Triple Crown', keys:[
    "Senior__Late Mar__Osaka Hai",
    "Senior__Late Apr__Tenno Sho (Spring)",
    "Senior__Late Jun__Takarazuka Kinen"
  ]},
  {id:'autumn_triple', title:'Senior Autumn Triple Crown', keys:[
    "Senior__Late Oct__Tenno Sho (Autumn)",
    "Senior__Late Nov__Japan Cup",
    "Senior__Late Dec__Arima Kinen"
  ]},
  {id:'dual_gp', title:'Dual Grand Prix', keys:[
    "Senior__Late Jun__Takarazuka Kinen",
    "Senior__Late Dec__Arima Kinen"
  ]},
  {id:'dual_miles', title:'Dual Miles', keys:[
    "Senior__Early Jun__Yasuda Kinen",
    "Senior__Late Nov__Mile Championship"
  ]},
  {id:'dual_sprints', title:'Dual Sprints', keys:[
    "Senior__Late Mar__Takamatsunomiya Kinen",
    "Senior__Late Sep__Sprinters Stakes"
  ]},
  {id:'dual_dirts', title:'Dual Dirts', keys:[
    "Senior__Late Feb__February Stakes",
    "Senior__Early Dec__Champions Cup"
  ]}
];

/* ===== State & storage ===== */
const DEFAULT_UMA=["Special Week","Silence Suzuka","Tokai Teio","Vodka","Daiwa Scarlet","Gold Ship","Mejiro McQueen","Symboli Rudolf","Rice Shower","Taiki Shuttle","Narita Brian","Agnes Tachyon","Hishi Amazon","El Condor Pasa","Manhattan Cafe"];
function blankInfo(){return{
  photo:null, recommendedKeys:[], mandatoryKeys:[],
  pace:[], track:{turf:"A",dirt:"A"}, distance:{sprint:"A",mile:"A",medium:"A",long:"A"},
  supports:[], altSupports:[], deckNote:"", skills:[], focusKeys:[]
};}
const state={umaList:loadUmaList(), currentUma:null, view:"recommended", sortKey:"year", sortDir:1};
function loadUmaList(){
  const raw=localStorage.getItem("umamusume.umalist"); let list=raw?JSON.parse(raw):{};
  if(!raw || Object.keys(list).length===0){ list={}; for(const n of DEFAULT_UMA){ list[n]={results:{},tags:"",recommended:[],info:blankInfo()}; } localStorage.setItem("umamusume.umalist",JSON.stringify(list));}
  for(const k of Object.keys(list)){
    const i=list[k].info||{}; list[k].info={...blankInfo(),...i};
    list[k].info.focusKeys=(list[k].info.focusKeys||[]).filter(validKey);
    list[k].info.recommendedKeys=(list[k].info.recommendedKeys||[]).filter(validKey);
    list[k].info.mandatoryKeys=(list[k].info.mandatoryKeys||[]).filter(validKey);
  } return list;
}
function saveUmaList(){ localStorage.setItem("umamusume.umalist",JSON.stringify(state.umaList)); }

/* ===== Helpers ===== */
const MONTH_ORDER=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function posIndex(pos){return pos==='Early'?1:pos==='Mid'?2:pos==='Late'?3:2;}
function parseDateStr(s){const [pos,mon]=s.trim().split(/\s+/);return{m:MONTH_ORDER.indexOf(mon),p:posIndex(pos||'Mid')};}
function sortByCalendar(a,b){const A=parseDateStr(a.date),B=parseDateStr(b.date); if(A.m!==B.m)return A.m-B.m; if(A.p!==B.p)return A.p-B.p; return a.name.localeCompare(b.name);}
function sortByYearThenCalendar(a,b,dir){const order={Junior:1,Classic:2,Senior:3}; const y=(order[a.year]||0)-(order[b.year]||0); if(y!==0)return dir*y; return sortByCalendar(a,b);}
function raceKey(r){return `${r.year}__${r.date}__${r.name}`;}
function validKey(k){return !!RACES.find(r=>raceKey(r)===k);}
function findRaceByKey(k){return RACES.find(r=>raceKey(r)===k);}
function textMatch(r,q){return (`${r.year} ${r.date} ${r.name} ${r.grade} ${r.distance} ${r.track}`.toLowerCase()).includes(q.toLowerCase());}
function getCheckedValues(el){return [...el.querySelectorAll("input:checked")].map(cb=>cb.value);}

/* ===== Aptitude-driven recommendation logic =====
   Only track and distance are used. Pace is ignored.
*/
const GOOD_RANKS=new Set(['S','A']);
function matchesAptitudes(r, info){
  const trackOK =
    (r.track==='Turf' && GOOD_RANKS.has((info.track?.turf||'A').toUpperCase())) ||
    (r.track==='Dirt' && GOOD_RANKS.has((info.track?.dirt||'A').toUpperCase()));
  if(!trackOK) return false;

  const distKey = r.distance.toLowerCase(); // sprint | mile | medium | long
  const distRank = (info.distance?.[distKey]||'A').toUpperCase();
  return GOOD_RANKS.has(distRank);
}

/* ===== UI refs ===== */
const umaSelect=document.getElementById("umaSelect");
const dashView=document.getElementById("dashView");
const dashGrades=document.getElementById("dashGrades");
const dashTracks=document.getElementById("dashTracks");
const dashDistances=document.getElementById("dashDistances");
const dashYears=document.getElementById("dashYears");
const showParticipated=document.getElementById("showParticipated");
const searchBox=document.getElementById("searchBox");
const clearFiltersBtn=document.getElementById("clearFilters");
const raceTBody=document.querySelector("#raceTable tbody");
const raceTable=document.getElementById("raceTable");
const tableHelp=document.getElementById("tableHelp");
const calendarWrap=document.getElementById("calendarWrap");
const calHelp=document.getElementById("calHelp");
const statTotal=document.getElementById("statTotal");
const statWins=document.getElementById("statWins");
const statLosses=document.getElementById("statLosses");
const viewBadge=document.getElementById("viewBadge");
const thName=document.querySelector('th[data-sort="name"]');
const thYear=document.querySelector('th[data-sort="year"]');
const sortNameInd=document.getElementById("sortName");
const sortYearInd=document.getElementById("sortYear");
/* rec editor refs */
const recEditor=document.getElementById("recEditor");
const editorTitle=document.getElementById("editorTitle");
const recSave=document.getElementById("recSave");
const recCancel=document.getElementById("recCancel");
const raceSearch=document.getElementById("raceSearch");
const filterYear=document.getElementById("filterYear");
const filterGrades=document.getElementById("filterGrades");
const filterDistances=document.getElementById("filterDistances");
const filterTracks=document.getElementById("filterTracks");
const raceResults=document.getElementById("raceResults");
const selectedRaces=document.getElementById("selectedRaces");
/* info panel + dialogs */
const umaPhotoEl=document.getElementById("umaPhoto");
const photoDialog=document.getElementById("photoDialog");
const photoLarge=document.getElementById("photoLarge");
const photoClose=document.getElementById("photoClose");
const infoEditor=document.getElementById("infoEditor");
const photoInput=document.getElementById("photoInput");
const photoRemoveBtn=document.getElementById("photoRemoveBtn");
const crownList=document.getElementById("crownList");
const editInfoBtn=document.getElementById("editInfoBtn");
/* add-to-list dialog */
const addToListDialog=document.getElementById("addToListDialog");
const addTitle=document.getElementById("addTitle");
const addRaceMeta=document.getElementById("addRaceMeta");
const btnAddRec=document.getElementById("btnAddRec");
const btnAddMand=document.getElementById("btnAddMand");
const btnAddCancel=document.getElementById("btnAddCancel");
/* editor field refs */
let editPace, editTurf, editDirt, editSprint, editMile, editMedium, editLong, editSupports, editAltSupports, editSkills, editDeckNote;

/* ===== Confirm discard helpers ===== */
let infoEditBackup = null;
let infoEditUma = null;
function closeDialog(d){ if(d?.close) d.close(); else d.removeAttribute('open'); }
function confirmDiscardAndClose() {
  if (!infoEditor.open) return;
  if (confirm('Discard changes to Umamusume details and close?')) {
    if (infoEditUma && infoEditBackup) {
      state.umaList[infoEditUma].info = JSON.parse(JSON.stringify(infoEditBackup));
      saveUmaList();
      render();
    }
    infoEditBackup = null;
    infoEditUma = null;
    closeDialog(infoEditor);
  }
}

/* ===== Events: filters/search/sort/view ===== */
[dashGrades,dashTracks,dashDistances,dashYears].forEach(el=>el.addEventListener("change", render));
showParticipated.addEventListener("change", render);
dashView.addEventListener("change", e=>{
  if(e.target.name==='view'){ state.view=e.target.value; clearSort(); render(); }
});
searchBox.oninput=render;
document.getElementById("clearEligibility").onclick=()=>{ render(); };
clearFiltersBtn.onclick=()=>{
  [dashGrades,dashTracks,dashDistances,dashYears].forEach(el=>el.querySelectorAll("input").forEach(cb=>cb.checked=false));
  showParticipated.checked=false;
  searchBox.value="";
  clearSort();
  render();
};
thName.addEventListener("click",()=>toggleSort("name"));
thYear.addEventListener("click",()=>toggleSort("year"));
function toggleSort(key){
  if(state.sortKey===key){state.sortDir=-state.sortDir;}
  else{state.sortKey=key;state.sortDir=1;}
  updateSortIndicators();render();
}
function clearSort(){state.sortKey="year";state.sortDir=1;updateSortIndicators();}
function updateSortIndicators(){
  sortNameInd.textContent=(state.sortKey==="name"?(state.sortDir>0?"â–²":"â–¼"):"");
  sortYearInd.textContent=(state.sortKey==="year"?(state.sortDir>0?"â–²":"â–¼"):"");
}

/* ===== Export/Import/Clear ===== */
document.getElementById("exportJson").onclick=()=>{
  const data={version:33,umaList:state.umaList};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="umamusume_race_progress.json";a.click();
};
document.getElementById("importJsonBtn").onclick=()=>document.getElementById("importFile").click();
document.getElementById("importFile").addEventListener("change",e=>{
  const f=e.target.files?.[0];if(!f)return;
  const fr=new FileReader();
  fr.onload=()=>{try{const d=JSON.parse(fr.result);if(d.umaList) localStorage.setItem("umamusume.umalist",JSON.stringify(d.umaList));
    state.umaList=loadUmaList();initUmaSelect();buildCrownUI();clearSort();render();alert("Import complete.");}catch{alert("Import failed. Invalid file.");}};
  fr.readAsText(f);
});
document.getElementById("clearUmaData").onclick=()=>{
  const u=state.currentUma;if(!u)return;
  if(confirm("Clear all data for "+u+"?")){
    state.umaList[u]={results:{},tags:"",recommended:[],info:blankInfo()};
    saveUmaList();initUmaSelect();buildCrownUI();render();
  }
};
document.getElementById("resetMarks").onclick=()=>{
  const u=state.currentUma;if(!u)return;
  if(confirm("Reset all win and loss marks for "+u+"?")){
    state.umaList[u].results={};saveUmaList();render();
  }
};

/* ===== Rec/Mand editor ===== */
let editorMode="recommended";
document.getElementById("editRecsBtn").onclick=()=>openEditor("recommended");
document.getElementById("editMandatoryBtn").onclick=()=>openEditor("mandatory");
recCancel.onclick=()=>recEditor.close();
recSave.onclick=()=>{
  const u=state.currentUma;if(!u)return;
  const keys=Array.from(selectedRaces.querySelectorAll("[data-key]")).map(n=>n.getAttribute("data-key"));
  if(editorMode==="recommended") state.umaList[u].info.recommendedKeys=keys; else state.umaList[u].info.mandatoryKeys=keys;
  saveUmaList();
  setView(editorMode);
  recEditor.close();
  render();
};
function openEditor(mode){
  editorMode=mode; editorTitle.textContent=(mode==="recommended")?"Edit recommended races":"Edit mandatory races";
  const u=state.currentUma;if(!u)return;
  raceSearch.value="";filterYear.value="";
  [...filterGrades.querySelectorAll("input")].forEach(cb=>cb.checked=false);
  [...filterDistances.querySelectorAll("input")].forEach(cb=>cb.checked=false);
  [...filterTracks.querySelectorAll("input")].forEach(cb=>cb.checked=false);

  selectedRaces.innerHTML="";
  const keys=(mode==="recommended")?(state.umaList[u].info.recommendedKeys||[]):(state.umaList[u].info.mandatoryKeys||[]);
  const sortedSel=keys.map(findRaceByKey).filter(Boolean).sort((a,b)=>sortByYearThenCalendar(a,b,1));
  if(sortedSel.length===0){selectedRaces.innerHTML=`<div class="empty">No races selected.</div>`;} else {for(const r of sortedSel) appendSelected(r);}
  renderRaceResults(); (recEditor.showModal?recEditor.showModal():recEditor.setAttribute('open','open'));
}
function renderRaceResults(){
  const q=raceSearch.value.trim().toLowerCase(); const y=filterYear.value;
  const gs=getCheckedValues(filterGrades), ds=getCheckedValues(filterDistances), ts=getCheckedValues(filterTracks);
  const selectedKeys=new Set(Array.from(selectedRaces.querySelectorAll("[data-key]")).map(n=>n.getAttribute("data-key")));
  let list=RACES.filter(r =>
    (!y || r.year===y) && (!gs.length || gs.includes(r.grade)) && (!ds.length || ds.includes(r.distance)) &&
    (!ts.length || ts.includes(r.track)) && (!q || textMatch(r,q)) && !selectedKeys.has(raceKey(r))
  ).sort((a,b)=>sortByYearThenCalendar(a,b,1));
  raceResults.innerHTML=""; if(list.length===0){raceResults.innerHTML=`<div class="empty">No matches.</div>`;return;}
  for(const r of list){
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<div><div><strong>${r.name}</strong></div><div class="meta">${r.year} â€¢ ${r.date} â€¢ (${r.grade}, ${r.distance}, ${r.track})</div></div><button class="iconbtn">Add</button>`;
    div.querySelector("button").onclick=()=>{appendSelected(r);renderRaceResults();}; raceResults.appendChild(div);
  }
}
function appendSelected(r){
  const empty=selectedRaces.querySelector(".empty"); if(empty) empty.remove();
  const div=document.createElement("div"); div.className="item"; div.setAttribute("data-key",raceKey(r));
  div.innerHTML=`<div><div><strong>${r.name}</strong></div><div class="meta">${r.year} â€¢ ${r.date} â€¢ (${r.grade}, ${r.distance}, ${r.track})</div></div><button class="iconbtn">Remove</button>`;
  div.querySelector("button").onclick=()=>{div.remove(); if(selectedRaces.children.length===0){selectedRaces.innerHTML=`<div class="empty">No races selected.</div>`;}};
  selectedRaces.appendChild(div);
}
raceSearch.oninput=filterYear.oninput=()=>renderRaceResults();
filterGrades.addEventListener("change",renderRaceResults);
filterDistances.addEventListener("change",renderRaceResults);
filterTracks.addEventListener("change",renderRaceResults);

/* ===== Crown titles UI ===== */
function buildCrownUI(){
  crownList.innerHTML=""; const u=state.currentUma;if(!u)return;
  const focusSet=new Set(state.umaList[u].info.focusKeys||[]);
  CROWNS.forEach(c=>{
    const keys=c.keys.filter(validKey);
    const allOn=keys.length>0 && keys.every(k=>focusSet.has(k));
    const someOn=!allOn && keys.some(k=>focusSet.has(k));
    const label=document.createElement("label"); const id="crown_"+c.id;
    label.htmlFor=id; label.innerHTML=`<input type="checkbox" id="${id}"> ${c.title}`;
    const cb=label.querySelector("input"); cb.checked=allOn; cb.indeterminate=someOn;
    cb.addEventListener("change",()=>{
      const set=new Set(state.umaList[state.currentUma].info.focusKeys||[]);
      if(cb.checked){ keys.forEach(k=>set.add(k)); } else { keys.forEach(k=>set.delete(k)); }
      state.umaList[state.currentUma].info.focusKeys=Array.from(set).filter(validKey);
      saveUmaList(); buildCrownUI(); render();
    });
    crownList.appendChild(label);
  });
}

/* ===== Photo lightbox ===== */
umaPhotoEl.addEventListener("click",()=>{const u=state.currentUma;if(!u)return;const src=state.umaList[u].info.photo;if(!src)return;photoLarge.src=src; (photoDialog.showModal?photoDialog.showModal():photoDialog.setAttribute('open','open'));});
photoClose.onclick=()=> (photoDialog.close?photoDialog.close():photoDialog.removeAttribute('open'));

/* ===== Details editor ===== */
const RANKS=['S','A','B','C','D','E','F','G'];
function fillRankSelect(sel, val='A'){ if(!sel) return; sel.innerHTML=RANKS.map(r=>`<option${r===val?' selected':''}>${r}</option>`).join(''); }
function makeSupportRow(type='SPD', name='', removable=false){
  const row=document.createElement('div');
  row.className='support-row'+(removable?'':' fixed');
  row.innerHTML=`
    <select class="support-type">
      <option>SPD</option><option>STAM</option><option>PWR</option><option>GUTS</option><option>WIT</option>
    </select>
    <input class="support-name" placeholder="Card name" />
    ${removable?'<button class="iconbtn remove">&times;</button>':''}
  `;
  row.querySelector('.support-type').value=normalizeType(type);
  row.querySelector('.support-name').value=name||'';
  if(removable){ row.querySelector('.remove').onclick=()=>row.remove(); }
  return row;
}
function makeSkillRow(text=''){
  const row=document.createElement('div'); row.className='skill-row';
  row.innerHTML=`<input class="skill-name" placeholder="Skill name (use global English names)" /><button class="iconbtn remove">&times;</button>`;
  row.querySelector('.skill-name').value=text||''; row.querySelector('.remove').onclick=()=>row.remove(); return row;
}
function normalizeType(t){
  const s=(t||'').toString().trim().toUpperCase();
  if(s.startsWith('SPD')||s==='SPEED') return 'SPD';
  if(s.startsWith('STA')||s==='STAMINA') return 'STAM';
  if(s.startsWith('PWR')||s==='POWER') return 'PWR';
  if(s.startsWith('GUT')) return 'GUTS';
  if(s.startsWith('WIT')||s==='WISDOM'||s==='INTELLIGENCE') return 'WIT';
  return 'SPD';
}
function parseSupportLine(line){
  const m=String(line||'').match(/^(\w+)\s*:\s*(.+)$/i);
  if(!m) return {type:'SPD',name:String(line||'')};
  return {type:normalizeType(m[1]), name:m[2]};
}

/* Open details editor */
document.getElementById("editInfoBtn").onclick=()=>{
  const u=state.currentUma;if(!u)return;

  infoEditUma = u;
  infoEditBackup = JSON.parse(JSON.stringify(state.umaList[u].info || blankInfo()));

  editPace=document.getElementById('editPace');
  editTurf=document.getElementById('editTurf');
  editDirt=document.getElementById('editDirt');
  editSprint=document.getElementById('editSprint');
  editMile=document.getElementById('editMile');
  editMedium=document.getElementById('editMedium');
  editLong=document.getElementById('editLong');
  editSupports=document.getElementById('editSupports');
  editAltSupports=document.getElementById('editAltSupports');
  editSkills=document.getElementById('editSkills');
  editDeckNote=document.getElementById('editDeckNote');

  [editTurf,editDirt,editSprint,editMile,editMedium,editLong].forEach(sel=>fillRankSelect(sel));

  const inf=state.umaList[u].info||blankInfo();

  [...editPace.querySelectorAll('input')].forEach(cb=>cb.checked = (inf.pace||[]).includes(cb.value));

  fillRankSelect(editTurf, inf.track?.turf||'A');
  fillRankSelect(editDirt, inf.track?.dirt||'A');
  fillRankSelect(editSprint, inf.distance?.sprint||'A');
  fillRankSelect(editMile, inf.distance?.mile||'A');
  fillRankSelect(editMedium, inf.distance?.medium||'A');
  fillRankSelect(editLong, inf.distance?.long||'A');

  editSupports.innerHTML='';
  const parsed=(inf.supports||[]).map(parseSupportLine).slice(0,6);
  for(let i=0;i<6;i++){
    const row=makeSupportRow(parsed[i]?.type||'SPD', parsed[i]?.name||'', false);
    editSupports.appendChild(row);
  }

  editAltSupports.innerHTML='';
  (inf.altSupports||[]).map(parseSupportLine).forEach(s=>editAltSupports.appendChild(makeSupportRow(s.type,s.name,true)));
  document.getElementById('addAltSupport').onclick=()=>editAltSupports.appendChild(makeSupportRow('SPD','',true));

  editSkills.innerHTML='';
  (inf.skills||[]).forEach(sk=>editSkills.appendChild(makeSkillRow(sk)));
  document.getElementById('addSkill').onclick=()=>editSkills.appendChild(makeSkillRow(''));

  editDeckNote.value = inf.deckNote||'';

  const saveBtn = document.getElementById('infoSave');
  saveBtn.onclick = (e)=>{
    e.preventDefault();
    try{
      const cur = state.umaList[u].info || blankInfo();
      cur.pace=[...document.querySelectorAll('#editPace input:checked')].map(cb=>cb.value);
      cur.track={turf:editTurf?.value||'A', dirt:editDirt?.value||'A'};
      cur.distance={sprint:editSprint?.value||'A', mile:editMile?.value||'A', medium:editMedium?.value||'A', long:editLong?.value||'A'};

      const sup=[];
      [...editSupports?.querySelectorAll('.support-row')||[]].forEach(r=>{
        const t=normalizeType(r.querySelector('.support-type')?.value||'SPD');
        const n=(r.querySelector('.support-name')?.value||'').trim();
        if(n) sup.push(`${t}: ${n}`);
      });
      cur.supports = sup;

      const alts=[];
      [...editAltSupports?.querySelectorAll('.support-row')||[]].forEach(r=>{
        const t=normalizeType(r.querySelector('.support-type')?.value||'SPD');
        const n=(r.querySelector('.support-name')?.value||'').trim();
        if(n) alts.push(`${t}: ${n}`);
      });
      cur.altSupports = alts;

      const skills=[];
      [...editSkills?.querySelectorAll('.skill-row .skill-name')||[]].forEach(inp=>{
        const v=(inp.value||'').trim(); if(v) skills.push(v);
      });
      cur.skills = skills;

      cur.deckNote = (editDeckNote?.value||'').trim();

      state.umaList[u].info = cur;
      saveUmaList();

      infoEditBackup = null;
      infoEditUma = null;

      render();
      closeDialog(infoEditor);
    }catch(err){
      console.error(err);
      alert("Save failed. Check console for details.");
    }
  };

  document.getElementById('infoClose').onclick = confirmDiscardAndClose;
  infoEditor.addEventListener('cancel', (e) => { e.preventDefault(); confirmDiscardAndClose(); }, {once:true});

  (infoEditor.showModal?infoEditor.showModal():infoEditor.setAttribute('open','open'));
};

/* Photo persistence */
photoInput?.addEventListener("change", e=>{
  const file=e.target.files?.[0]; if(!file) return;
  const u=state.currentUma; if(!u) return;
  const fr=new FileReader();
  fr.onload=()=>{ state.umaList[u].info.photo = String(fr.result); saveUmaList(); render(); };
  fr.readAsDataURL(file); photoInput.value="";
});
photoRemoveBtn?.addEventListener("click", ()=>{
  const u=state.currentUma; if(!u) return;
  state.umaList[u].info.photo=null; saveUmaList(); render();
});

/* Add to recommended/mandatory from All view and Calendar */
function addRaceTo(listType, key){
  if(!validKey(key)) return;
  const u=state.currentUma; if(!u) return;
  const info = state.umaList[u].info || blankInfo();
  if(listType==='recommended'){
    if(!info.recommendedKeys.includes(key)) info.recommendedKeys.push(key);
  } else if(listType==='mandatory'){
    if(!info.mandatoryKeys.includes(key)) info.mandatoryKeys.push(key);
  }
  info.recommendedKeys = (info.recommendedKeys||[]).filter(validKey);
  info.mandatoryKeys   = (info.mandatoryKeys||[]).filter(validKey);
  state.umaList[u].info = info;
  saveUmaList();
  render();
}

/* Add-to-list dialog helpers */
let pendingAddKey=null;
function openAddDialog(key){
  const r=findRaceByKey(key); if(!r) return;
  pendingAddKey=key;
  addTitle.textContent=r.name;
  addRaceMeta.textContent=`${r.year} â€¢ ${r.date} â€¢ (${r.grade}, ${r.distance}, ${r.track})`;
  (addToListDialog.showModal?addToListDialog.showModal():addToListDialog.setAttribute('open','open'));
}
btnAddRec.onclick=()=>{ if(pendingAddKey){ addRaceTo('recommended', pendingAddKey); } closeDialog(addToListDialog); };
btnAddMand.onclick=()=>{ if(pendingAddKey){ addRaceTo('mandatory', pendingAddKey); } closeDialog(addToListDialog); };
btnAddCancel.onclick=()=> closeDialog(addToListDialog);

/* ===== Render ===== */
function initUmaSelect(){
  umaSelect.innerHTML="";
  const names=Object.keys(state.umaList).sort();
  for(const n of names){const opt=document.createElement("option");opt.value=n;opt.textContent=n;umaSelect.appendChild(opt);}
  const addOpt=document.createElement("option"); addOpt.value="__add__"; addOpt.textContent="+ Add new"; umaSelect.appendChild(addOpt);
}
umaSelect.addEventListener("change", ()=>{
  if(umaSelect.value==="__add__"){
    const name=prompt("Enter Umamusume name");
    if(name && !state.umaList[name]){state.umaList[name]={results:{},tags:"",recommended:[],info:blankInfo()};saveUmaList();initUmaSelect();umaSelect.value=name;}
    else umaSelect.value=state.currentUma||Object.keys(state.umaList)[0];
  }
  state.currentUma=umaSelect.value;
  setView('recommended');
  buildCrownUI(); render();
});
function setView(v){
  state.view=v;
  [...dashView.querySelectorAll('input[name="view"]')].forEach(i=> i.checked=(i.value===v));
}

function buildRecommendedBase(inf){
  const aptitudeSet = new Set(
    RACES.filter(r=>matchesAptitudes(r, inf)).map(r=>raceKey(r))
  );
  const manual = new Set((inf.recommendedKeys||[]).filter(validKey));
  return RACES.filter(r=> aptitudeSet.has(raceKey(r)) || manual.has(raceKey(r)));
}

function render(){
  if(!state.currentUma){state.currentUma=Object.keys(state.umaList)[0]||"Special Week";}
  if(!state.umaList[state.currentUma]){state.umaList[state.currentUma]={results:{},tags:"",recommended:[],info:blankInfo()}; saveUmaList(); initUmaSelect();}
  umaSelect.value=state.currentUma;

  const inf=state.umaList[state.currentUma].info||blankInfo();

  if(inf.photo){umaPhotoEl.src=inf.photo;umaPhotoEl.style.display="block";}
  else{umaPhotoEl.removeAttribute("src");umaPhotoEl.style.display="none";}

  document.getElementById("infoPace").textContent=(inf.pace&&inf.pace.length)?inf.pace.join(" / "):"None";
  document.getElementById("infoTrack").textContent=`Turf ${inf.track.turf}, Dirt ${inf.track.dirt}`;
  document.getElementById("infoAptitude").textContent=`Sprint ${inf.distance.sprint}, Mile ${inf.distance.mile}, Medium ${inf.distance.medium}, Long ${inf.distance.long}`;
  renderList(document.getElementById("infoSupports"), inf.supports||[]);
  document.getElementById("supportsWarn").style.display=(inf.supports && inf.supports.length===6)?"none":"block";
  renderList(document.getElementById("infoAltSupports"), inf.altSupports||[]);
  document.getElementById("infoDeckNote").textContent=inf.deckNote||"None";
  renderList(document.getElementById("infoSkills"), inf.skills||[]);

  let base=RACES.slice();
  const results=state.umaList[state.currentUma].results||{};

  if (showParticipated.checked) {
    const keys=Object.keys(results).filter(k=>results[k]==='win'||results[k]==='loss');
    base = keys.map(findRaceByKey).filter(Boolean);
    viewBadge.textContent = (state.view==='calendar') ? "Calendar â€¢ Participated" : "Participated";
  } else {
    if(state.view==="recommended"){
      base = buildRecommendedBase(inf);
      viewBadge.textContent = "Recommended (aptitude)";
    } else if(state.view==="mandatory"){
      base = (inf.mandatoryKeys||[]).length ? RACES.filter(r=>inf.mandatoryKeys.includes(raceKey(r))) : [];
      viewBadge.textContent = "Mandatory";
    } else if(state.view==="calendar"){
      base = RACES.slice();
      viewBadge.textContent = "Calendar";
    } else {
      base = RACES.slice();
      viewBadge.textContent = "All races";
    }
  }

  const gs=getCheckedValues(dashGrades), ts=getCheckedValues(dashTracks), ds=getCheckedValues(dashDistances), ys=getCheckedValues(dashYears);
  const q=searchBox.value.trim();

  let view=base.filter(r =>
    (!gs.length||gs.includes(r.grade)) && (!ts.length||ts.includes(r.track)) &&
    (!ds.length||ds.includes(r.distance)) && (!ys.length||ys.includes(r.year)) &&
    (!q || textMatch(r,q))
  );

  let wins=0, losses=0;
  for(const r of view){
    const res=results[raceKey(r)]||"";
    if(res==="win") wins++; else if(res==="loss") losses++;
  }
  statTotal.textContent=view.length; statWins.textContent=wins; statLosses.textContent=losses;

  if(state.view==='calendar'){
    raceTable.style.display='none';
    tableHelp.style.display='none';
    calendarWrap.style.display='';
    calHelp.style.display='';
    renderCalendar(view, results, inf);
  } else {
    calendarWrap.style.display='none';
    calHelp.style.display='none';
    raceTable.style.display='';
    tableHelp.style.display='';
    renderTable(view, results, inf);
  }

  buildCrownUI();
}

function renderTable(view, results, inf){
  const focusSet=new Set((inf.focusKeys||[]).filter(validKey));

  // Sorting: default and â€œyearâ€ key â†’ by year then calendar; â€œnameâ€ â†’ by name with dir.
  if(state.sortKey==='name'){
    view.sort((a,b)=> state.sortDir * a.name.localeCompare(b.name));
  }else{
    const dir = (state.sortKey==='year') ? state.sortDir : 1; // default to Year â†‘ when not explicitly sorting by name
    view.sort((a,b)=> sortByYearThenCalendar(a,b,dir));
  }

  raceTBody.innerHTML="";
  for(const r of view){
    const key=raceKey(r); const res=results[key]||"";
    const tr=document.createElement("tr"); const classes=[];
    if(res==="win") classes.push("win"); else if(res==="loss") classes.push("loss");
    if(focusSet.has(key)) classes.push("focus");
    tr.className=classes.join(" ");

    const addControls = (state.view === 'all')
      ? `<div class="inline-actions">
           <button class="iconbtn add-rec" data-key="${key}">+ Rec</button>
           <button class="iconbtn add-mand" data-key="${key}">+ Mand</button>
         </div>`
      : ``;

    tr.innerHTML=`
      <td>${r.date}</td>
      <td>${r.name}</td>
      <td>(${r.grade}, ${r.distance}, ${r.track})</td>
      <td>${r.year}</td>
      <td>
        <select data-key="${key}">
          <option value="">Not set</option>
          <option value="win"${res==="win"?" selected":""}>Win</option>
          <option value="loss"${res==="loss"?" selected":""}>Loss</option>
        </select>
        ${addControls}
      </td>`;
    raceTBody.appendChild(tr);
  }

  raceTBody.querySelectorAll("select").forEach(sel=>{
    sel.addEventListener("change", e=>{
      const key=e.target.dataset.key, val=e.target.value;
      if(val) state.umaList[state.currentUma].results[key]=val; else delete state.umaList[state.currentUma].results[key];
      saveUmaList(); render();
    });
  });
  raceTBody.querySelectorAll(".add-rec").forEach(btn=>{
    btn.addEventListener("click", ()=> addRaceTo('recommended', btn.dataset.key));
  });
  raceTBody.querySelectorAll(".add-mand").forEach(btn=>{
    btn.addEventListener("click", ()=> addRaceTo('mandatory', btn.dataset.key));
  });
}

function renderCalendar(view, results, inf){
  const byMonth = Array.from({length:12}, ()=>[]);
  view.forEach(r=>{ const m=parseDateStr(r.date).m; if(m>=0) byMonth[m].push(r); });
  byMonth.forEach(list=> list.sort((a,b)=> sortByYearThenCalendar(a,b,1))); // Year â†‘ inside each month

  const focusSet=new Set((inf.focusKeys||[]).filter(validKey));
  calendarWrap.innerHTML="";
  for(let i=0;i<12;i++){
    const monthBox=document.createElement("div");
    monthBox.className="month";
    monthBox.innerHTML=`<h4>${MONTH_ORDER[i]}</h4>`;
    if(byMonth[i].length===0){
      const empty=document.createElement("div");
      empty.className="empty";
      empty.textContent="No races";
      monthBox.appendChild(empty);
    } else {
      for(const r of byMonth[i]){
        const key=raceKey(r);
        const res=results[key]||"";
        const tag = res==="win" ? `<span class="tag-win">Win</span>` : res==="loss" ? `<span class="tag-loss">Loss</span>` : ``;
        const focus = focusSet.has(key) ? ` â€¢ Focus` : ``;
        const row=document.createElement("div");
        row.className="race-row";
        row.innerHTML=`
          <div class="rtitle" data-key="${key}">[${r.date.split(' ')[0]}] ${r.name}</div>
          <div class="rmeta">${r.year} â€¢ ${r.grade}, ${r.distance}, ${r.track}${focus} ${tag}</div>
        `;
        monthBox.appendChild(row);
      }
    }
    calendarWrap.appendChild(monthBox);
  }
  calendarWrap.querySelectorAll(".rtitle").forEach(el=>{
    el.addEventListener("click", ()=> openAddDialog(el.dataset.key));
  });
}

function renderList(container, arr){
  container.innerHTML=""; const list=Array.isArray(arr)?arr.filter(Boolean):[];
  if(list.length===0){container.innerHTML="<li>None</li>"; return;}
  for(const item of list){const li=document.createElement("li"); li.textContent=item; container.appendChild(li);}
}

/* ===== Boot ===== */
(function boot(){
  initUmaSelect();
  state.currentUma = Object.keys(state.umaList)[0] || "Special Week";
  umaSelect.value = state.currentUma;
  setView('recommended');
  buildCrownUI();
  updateSortIndicators();
  render();
})();
</script>
</body>
</html>
