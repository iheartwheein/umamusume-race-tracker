<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Umamusume Race Tracker</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151924; --soft:#1b2030; --muted:#9aa4b2;
    --text:#e7ecf3; --acc:#5aa7ff; --good:#45d48a; --bad:#ff7a7a; --line:#23283a; --warn:#ffb454;
    --winRow:#2b2405; --winRowBorder:#8a6d0a;
    --lossRow:#2b0f12; --lossRowBorder:#8a1f2a;
    --focusRow:#0f2b1c; --focusBorder:#2aa759;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0 0 10px 0;font-size:16px}

  .controls{display:grid;grid-template-columns:minmax(220px,260px) 1fr auto;gap:10px;align-items:end;width:100%}
  .ctrl{display:flex;flex-direction:column;gap:4px}
  .ctrl .label{font-size:12px;color:var(--muted)}
  .grow input{width:100%}

  select, input, button, textarea{background:var(--soft);color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  button.primary{background:var(--acc);border-color:transparent;color:#041a2e}
  .iconbtn{padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:var(--soft);color:var(--text)}

  .wrap{padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px}
  .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px;color:var(--muted)}
  .panel .body{padding:12px 14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}

  /* Dashboard layout */
  .toolbar{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:12px;
    margin-bottom:10px;
    grid-template-areas:
      "filters career"
      "view view";
  }
  #viewBox{ grid-area:view; }
  #filtersBox{ grid-area:filters; }
  #careerTools{ grid-area:career; }

  .toolbox{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px}
  .toolbox h3{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
  .tools-grid{display:grid;grid-template-columns:repeat(4, minmax(140px,1fr));gap:12px}
  .checkgroup{display:flex;flex-wrap:wrap;gap:10px 12px;background:#12182a;border:1px solid var(--line);border-radius:8px;padding:8px}
  .tools-actions{display:flex;gap:8px;align-items:center;margin-top:8px}

  table{width:100%;border-collapse:collapse;font-size:13px}
  th, td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
  th{position:sticky;top:0;background:linear-gradient(#151924,#141824);z-index:1;user-select:none}
  th.sortable{cursor:pointer}
  tr:hover td{background:#131826}

  tr.win td{background:var(--winRow)}
  tr.win td:first-child{border-left:2px solid var(--winRowBorder)}
  tr.loss td{background:var(--lossRow)}
  tr.loss td:first-child{border-left:2px solid var(--lossRowBorder)}
  tr.focus td{background:var(--focusRow)}
  tr.focus td:first-child{border-left:2px solid var(--focusBorder)}

  .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:2px;border:1px solid var(--line)}
  .dot.win{background:linear-gradient(180deg,#f2d85c,#b89415);border-color:#b89415}
  .dot.loss{background:#c43d3d;border-color:#c43d3d}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .card{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px}
  .card strong{display:block;font-size:18px;margin-bottom:2px}
  .pill{display:inline-block;font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
  .pill.small{font-size:10px;padding:1px 6px}
  .subtle{color:var(--muted);font-size:12px}
  .warn-text{color:var(--warn)}
  .info-grid{display:grid;grid-template-columns:1fr;gap:8px}
  .info-item{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px}
  .info-item h3{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
  .list{margin:0;padding-left:18px}
  .list li{margin:2px 0}

  dialog{border:1px solid var(--line);border-radius:12px;background:var(--panel);color:var(--text);padding:0;max-width:980px}
  dialog header{padding:12px 14px;border-bottom:1px solid var(--line)}
  dialog .body{padding:12px 14px}
  .editor-section{margin-bottom:12px}
  .mini{font-size:12px;color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .flex{display:flex;gap:8px;align-items:center}
  .slim{padding:6px 8px}
  .delbtn{border:1px solid var(--line);background:#2b1b1b;color:#ffb0b0;border-radius:8px;padding:6px 8px}

  .uma-photo{width:100%;height:200px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#0f1016;cursor:pointer}
  #photoDialog img{max-width:96vw;max-height:80vh;display:block}

  /* Calendar */
  #calendarWrap{display:none;gap:8px}
  #calendarGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:1200px){#calendarGrid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:720px){#calendarGrid{grid-template-columns:1fr}}
  .box{border:1px solid var(--line);border-radius:10px;background:var(--soft);padding:10px}
  #calendarGrid .box{min-height:120px}

  /* Race links (calendar) */
  .race-link,
  .race-link:visited,
  .race-link:hover,
  .race-link:active{
    color:var(--text);
    text-decoration:underline;
    text-underline-offset:2px;
  }
  .race-link:hover{opacity:.9}

  /* Popover */
  .popover{
    position:fixed; left:0; top:0; display:none; z-index:1000;
    background:var(--panel); border:1px solid var(--line); border-radius:10px;
    padding:10px 12px; width:min(340px, 90vw); box-shadow:0 14px 38px rgba(0,0,0,.55)
  }
  .popover .title{font-weight:700;margin-bottom:4px}
  .popover .meta{color:var(--muted);font-size:12px;margin-bottom:10px}
  .popover .actions{display:flex;gap:8px;justify-content:flex-end}

  /* Career tools UI (single column) */
  #careerTools .tmpl-title { margin: 8px 0 6px; font-size: 12px; color: var(--muted); }
  #careerTools .tmpl-items,#careerTools #crownList { display:block; }
  #careerTools #crownList label, #careerTools .tmpl-items label { display:block!important; margin:6px 0!important; line-height:1.35; white-space:normal; }
  #careerTools input[type="checkbox"] { margin-right:8px; vertical-align:middle; }

  /* Skills editor layout so add button never overlaps */
  #editSkills { display:flex; flex-direction:column; gap:8px; }
  .skill-row { display:flex; gap:8px; align-items:center; }
  .skill-row input { flex:1; }
</style>
</head>
<body>
<header>
  <h1>Umamusume race tracker</h1>
  <div class="controls">
    <div class="ctrl">
      <span class="label">Umamusume</span>
      <select id="umaSelect"></select>
    </div>
    <div class="ctrl grow">
      <span class="label">Quick search</span>
      <input id="searchBox" placeholder="Search race, month, year" />
    </div>
    <div class="ctrl" style="align-items:flex-start">
      <button id="clearFilters">Clear filters</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Left -->
  <section class="panel">
    <h2>Umamusume Details</h2>
    <div class="body">
      <div class="info-grid">
        <div class="info-item">
          <h3>Photo</h3>
          <img id="umaPhoto" class="uma-photo" alt="Umamusume photo (click to enlarge)" />
          <div class="subtle" style="margin-top:6px">jpg or png. Click the photo to enlarge. Upload in <em>Edit Umamusume details</em>.</div>
        </div>
        <div class="info-item"><h3>Track Aptitude</h3><div id="infoTrack">None</div></div>
        <div class="info-item"><h3>Distance Aptitude</h3><div id="infoAptitude">None</div></div>
        <div class="info-item"><h3>Pace Aptitude</h3><div id="infoPace">None</div></div>
        <div class="info-item">
          <h3>Recommended Support Cards <span class="subtle">(6 total)</span></h3>
          <ul id="infoSupports" class="list"><li>None</li></ul>
          <div id="supportsWarn" class="warn-text" style="margin-top:6px;display:none">Exactly 6 cards are required. Open <em>Edit Umamusume details</em>.</div>
        </div>
        <div class="info-item"><h3>Alternative Support Cards</h3><ul id="infoAltSupports" class="list"><li>None</li></ul></div>
        <div class="info-item"><h3>Support Deck Notes</h3><div id="infoDeckNote">None</div></div>
        <div class="info-item"><h3>Recommended Skills</h3><ul id="infoSkills" class="list"><li>None</li></ul></div>
      </div>
      <div class="row" style="margin-top:10px"><button id="editInfoBtn">Edit Umamusume Details</button></div>
    </div>

    <h2>Data</h2>
    <div class="body">
      <div class="row">
        <button id="exportJson">Export progress</button>
        <button id="importJsonBtn">Import progress</button>
        <button id="clearUmaData" class="bad">Clear selected</button>
      </div>
      <input id="importFile" type="file" accept="application/json" hidden />
      <p class="subtle">Data saves in your browser per Umamusume.</p>
    </div>
  </section>

  <!-- Right -->
  <section class="panel">
    <h2>Dashboard</h2>
    <div class="body">
      <div class="toolbar">
        <!-- FILTERS -->
        <div class="toolbox" id="filtersBox">
          <h3>Filters</h3>
          <div class="tools-grid">
            <div>
              <div class="subtle">Grades</div>
              <div class="checkgroup" id="dashGrades">
                <label><input type="checkbox" value="G1"> G1</label>
                <label><input type="checkbox" value="G2"> G2</label>
                <label><input type="checkbox" value="G3"> G3</label>
              </div>
            </div>
            <div>
              <div class="subtle">Track</div>
              <div class="checkgroup" id="dashTracks">
                <label><input type="checkbox" value="Turf"> Turf</label>
                <label><input type="checkbox" value="Dirt"> Dirt</label>
              </div>
            </div>
            <div>
              <div class="subtle">Distance</div>
              <div class="checkgroup" id="dashDistances">
                <label><input type="checkbox" value="Sprint"> Sprint</label>
                <label><input type="checkbox" value="Mile"> Mile</label>
                <label><input type="checkbox" value="Medium"> Medium</label>
                <label><input type="checkbox" value="Long"> Long</label>
              </div>
            </div>
            <div>
              <div class="subtle">Year</div>
              <div class="checkgroup" id="dashYears">
                <label><input type="checkbox" value="Junior"> Junior</label>
                <label><input type="checkbox" value="Classic"> Classic</label>
                <label><input type="checkbox" value="Senior"> Senior</label>
                <label><input type="checkbox" value="EX"> EX</label>
              </div>
            </div>
          </div>
          <div class="tools-actions">
            <button id="clearEligibility">Clear tag filter</button>
            <span class="subtle">This also turns off any tag based filtering.</span>
          </div>
        </div>

        <!-- CAREER TOOLS -->
        <div class="toolbox" id="careerTools">
          <h3>Career tools</h3>
          <div class="tmpl-title">Crown Titles</div>
          <div id="crownList" class="tmpl-items"></div>
        </div>

        <!-- VIEW -->
        <div class="toolbox" id="viewBox">
          <h3>View</h3>
          <div class="checkgroup" id="viewGroup" style="gap:12px">
            <label><input type="radio" name="view" value="recommended"> Recommended</label>
            <label><input type="radio" name="view" value="career"> Career</label>
            <label><input type="radio" name="view" value="all" checked> All races</label>
            <label><input type="radio" name="view" value="calendar"> Calendar</label>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="card"><strong id="statTotal">0</strong>Total races</div>
        <div class="card"><strong id="statWins" class="good">0</strong>Wins</div>
        <div class="card"><strong id="statLosses" class="bad">0</strong>Losses</div>
        <div class="card">
          <strong style="font-size:14px">Actions</strong>
          <div class="legend" style="margin-top:6px">
            <span class="chip"><span class="dot win"></span>Win</span>
            <span class="chip"><span class="dot loss"></span>Loss</span>
          </div>
          <div class="row" style="margin-top:8px;margin-bottom:0">
            <button id="resetMarks">Reset marks</button>
          </div>
        </div>
      </div>
    </div>

    <h2>Races <span id="viewBadge" class="pill">All races</span></h2>
    <div class="body">
      <!-- Calendar view -->
      <div id="calendarWrap">
        <div class="subtle" style="margin-bottom:8px">Click a race title for options.</div>
        <div id="calendarGrid"></div>
      </div>

      <!-- Table view -->
      <table id="raceTable">
        <thead>
          <tr>
            <th style="width:130px">Date</th>
            <th class="sortable" data-sort="name">Race <span id="sortName" class="sort-ind"></span></th>
            <th style="width:220px">Details</th>
            <th class="sortable" data-sort="year" style="width:90px">Year <span id="sortYear" class="sort-ind"></span></th>
            <th style="width:240px">Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="subtle" style="margin-top:8px">Click the Race or Year header to sort. Click again to toggle direction.</p>
    </div>
  </section>
</div>

<!-- Popover -->
<div id="racePopover" class="popover" role="dialog" aria-modal="false">
  <div class="title" id="popTitle"></div>
  <div class="meta" id="popMeta"></div>
  <div class="actions">
    <button id="popPrimaryBtn" class="primary"></button>
    <button id="popCloseBtn" class="iconbtn">Close</button>
  </div>
</div>

<!-- Career list / confirmation -->
<dialog id="careerConfirm">
  <header><strong>Career races</strong></header>
  <div class="body">
    <div id="careerListBox" class="box" style="max-height:320px;overflow:auto"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="careerClose" class="iconbtn">Close</button>
    </div>
  </div>
</dialog>

<!-- Photo lightbox -->
<dialog id="photoDialog">
  <header><strong>Umamusume photo</strong></header>
  <div class="body">
    <img id="photoLarge" alt="Umamusume photo" />
    <div class="row" style="margin-top:10px"><button id="photoClose">Close</button></div>
  </div>
</dialog>

<!-- Full details editor -->
<dialog id="infoEditor">
  <header><strong>Edit Umamusume Details</strong></header>
  <div class="body">
    <div class="editor-section">
      <h4>Photo</h4>
      <div class="row">
        <input id="photoInput" type="file" accept="image/*" />
        <button id="photoRemoveBtn" class="iconbtn">Remove photo</button>
      </div>
      <div class="mini">Photo saves as soon as you pick a file.</div>
    </div>

    <div class="editor-section">
      <h4>Track Aptitude</h4>
      <div class="grid-2">
        <label>Turf
          <select id="editTurf"></select>
        </label>
        <label>Dirt
          <select id="editDirt"></select>
        </label>
      </div>
    </div>

    <div class="editor-section">
      <h4>Distance Aptitude</h4>
      <div class="grid-4">
        <label>Sprint
          <select id="editSprint"></select>
        </label>
        <label>Mile
          <select id="editMile"></select>
        </label>
        <label>Medium
          <select id="editMedium"></select>
        </label>
        <label>Long
          <select id="editLong"></select>
        </label>
      </div>
    </div>

    <!-- NEW: Pace aptitude -->
    <div class="editor-section">
      <h4>Pace Aptitude</h4>
      <div class="grid-2">
        <label>Front runner
          <select id="editPaceFront"></select>
        </label>
        <label>Pace chaser
          <select id="editPaceChaser"></select>
        </label>
        <label>Late surger
          <select id="editPaceLate"></select>
        </label>
        <label>End closer
          <select id="editPaceEnd"></select>
        </label>
      </div>
      <div class="mini">Some Umamusume can excel at two paces—set the letters that apply.</div>
    </div>

    <div class="editor-section">
      <h4>Recommended support cards <span class="mini">(exactly 6)</span></h4>
      <div id="editSupports"></div>
    </div>

    <div class="editor-section">
      <h4>Alternative support cards</h4>
      <div id="editAltSupports"></div>
      <div class="row"><button id="addAltSupport" class="iconbtn">+ Add alternative</button></div>
    </div>

    <div class="editor-section">
      <h4>Recommended skills</h4>
      <div id="editSkills"></div>
      <div class="row" style="margin-top:8px"><button id="addSkill" class="iconbtn">+ Add skill</button></div>
    </div>

    <div class="editor-section">
      <h4>Support deck notes</h4>
      <textarea id="editDeckNote" rows="4" placeholder="Notes about deck composition, variations, and reasoning"></textarea>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="infoSave" class="primary">Save</button>
      <button id="infoClose" class="iconbtn">Close</button>
    </div>
  </div>
</dialog>

<script>
/* ===== RACES (FULL LIST) ===== */
const RACES = [
  // ===== Junior: 14 =====
  {date:'Late Jul', year:'Junior', name:'Hakodate Junior Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Aug', year:'Junior', name:'Niigata Junior Stakes', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Sep', year:'Junior', name:'Sapporo Junior Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Sep', year:'Junior', name:'Kokura Junior Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Oct', year:'Junior', name:'Saudi Arabia Royal Cup', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Oct', year:'Junior', name:'Artemis Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Nov', year:'Junior', name:'Keio Hai Junior Stakes', grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Nov', year:'Junior', name:'Daily Hai Junior Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Nov', year:'Junior', name:'Fantasy Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Nov', year:'Junior', name:'Tokyo Sports Hai Junior Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Nov', year:'Junior', name:'Kyoto Junior Stakes', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Junior', name:'Hanshin Juvenile Fillies', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Early Dec', year:'Junior', name:'Asahi Hai Futurity Stakes', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Late Dec', year:'Junior', name:'Hopeful Stakes', grade:'G1', distance:'Medium', track:'Turf'},

  // ===== Classic: 85 =====
  {date:'Early Jan', year:'Classic', name:'Shinzan Kinen', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Jan', year:'Classic', name:'Fairy Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Jan', year:'Classic', name:'Keisei Hai', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Feb', year:'Classic', name:'Kisaragi Sho', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Feb', year:'Classic', name:'Queen Cup', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Feb', year:'Classic', name:'Kyodo News Hai', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Mar', year:'Classic', name:"Tulip Sho", grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Mar', year:'Classic', name:"Yayoi Sho", grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Mar', year:'Classic', name:"Fillies' Revue", grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Spring Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Falcon Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Flower Cup', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Mar',  year:'Classic', name:'Mainichi Hai', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'Satsuki Sho', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'Oka Sho', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'New Zealand Trophy', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Apr', year:'Classic', name:'Arlington Cup', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Apr',  year:'Classic', name:'Flora Stakes', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Apr',  year:'Classic', name:'Aoba Sho', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early May', year:'Classic', name:'NHK Mile Cup', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Early May', year:'Classic', name:'Kyoto Shimbun Hai', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Classic', name:'Japanese Derby (Tokyo Yushun)', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Classic', name:'Japanese Oaks', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Classic', name:'Aoi Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Yasuda Kinen', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Epsom Cup', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Naruo Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jun', year:'Classic', name:'Mermaid Stakes', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jun',  year:'Classic', name:'Takarazuka Kinen', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Jun',  year:'Classic', name:'Unicorn Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Late Jun',  year:'Classic', name:'Hakodate Sprint Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'Japan Dirt Derby', grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Early Jul', year:'Classic', name:'Radio Nikkei Sho', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'CBC Sho', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'Procyon Stakes', grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Jul', year:'Classic', name:'Tanabata Sho', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jul', year:'Classic', name:'Hakodate Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jul',  year:'Classic', name:'Queen Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Jul',  year:'Classic', name:'Chukyo Kinen', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Jul',  year:'Classic', name:'Ibis Summer Dash', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Aug', year:'Classic', name:'Leopard Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Aug', year:'Classic', name:'Kokura Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Aug', year:'Classic', name:'Sekiya Kinen', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Aug', year:'Classic', name:'Elm Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Aug', year:'Classic', name:'Sapporo Kinen', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Aug', year:'Classic', name:'Kitakyushu Kinen', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Aug',  year:'Classic', name:'Keeneland Cup', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Rose Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Centaur Stakes', grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Niigata Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Keisei Hai Autumn Handicap', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Sep', year:'Classic', name:'Shion Stakes', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'Sprinters Stakes', grade:'G1', distance:'Sprint', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'St. Lite Kinen', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'Kobe Shimbun Hai', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'All Comers', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Classic', name:'Sirius Stakes', grade:'G3', distance:'Medium', track:'Dirt'},
  {date:'Early Oct', year:'Classic', name:'Kyoto Daishoten', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Oct', year:'Classic', name:'Mainichi Okan', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Oct', year:'Classic', name:'Fuchu Umamusume Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Tenno Sho (Autumn)', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Kikuka Sho', grade:'G1', distance:'Long', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Shuka Sho', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Fuji Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Late Oct',  year:'Classic', name:'Swan Stakes', grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Nov', year:'Classic', name:'JBC Classic', grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'JBC Sprint', grade:'G1', distance:'Sprint', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:"JBC Ladies' Classic", grade:'G1', distance:'Mile', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'Queen Elizabeth II Cup', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Early Nov', year:'Classic', name:'Copa Republica Argentina', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Early Nov', year:'Classic', name:'Miyako Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'Musashino Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Nov', year:'Classic', name:'Fukushima Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Classic', name:'Japan Cup', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Classic', name:'Mile Championship', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Late Nov',  year:'Classic', name:'Keihan Hai', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Champions Cup', grade:'G1', distance:'Mile', track:'Dirt'},
  {date:'Early Dec', year:'Classic', name:'Stayers Stakes', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Challenge Cup', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Chunichi Shimbun Hai', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Classic', name:'Capella Stakes', grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Dec', year:'Classic', name:'Turquoise Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Dec',  year:'Classic', name:'Tokyo Daishoten', grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Late Dec',  year:'Classic', name:'Arima Kinen', grade:'G1', distance:'Long', track:'Turf'},
  {date:'Late Dec',  year:'Classic', name:'Hanshin Cup', grade:'G2', distance:'Sprint', track:'Turf'},

  // ===== Senior: 87 =====
  {date:'Early Jan', year:'Senior', name:'Nikkei Shinshun Hai', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Jan', year:'Senior', name:'Kyoto Kimpai', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Jan', year:'Senior', name:'Nakayama Kimpai', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jan', year:'Senior', name:'Aichi Hai', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jan',  year:'Senior', name:'Tokai Stakes', grade:'G2', distance:'Mile', track:'Dirt'},
  {date:'Late Jan',  year:'Senior', name:'American JCC', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Jan',  year:'Senior', name:'Silk Road Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Jan',  year:'Senior', name:'Negishi Stakes', grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Feb', year:'Senior', name:'Kyoto Kinen', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Feb', year:'Senior', name:'Tokyo Shimbun Hai', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'February Stakes', grade:'G1', distance:'Mile', track:'Dirt'},
  {date:'Late Feb',  year:'Senior', name:'Nakayama Kinen', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Kyoto Umamusume Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Diamond Stakes', grade:'G3', distance:'Long', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Kokura Daishoten', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Feb',  year:'Senior', name:'Hankyu Hai', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Mar', year:'Senior', name:'Kinko Sho', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Mar', year:'Senior', name:'Ocean Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Mar', year:'Senior', name:'Nakayama Umamusume Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Osaka Hai', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Takamatsunomiya Kinen', grade:'G1', distance:'Sprint', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Nikkei Sho', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'Hanshin Daishoten', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Late Mar',  year:'Senior', name:'March Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Apr', year:'Senior', name:'Hanshin Umamusume Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Apr', year:'Senior', name:'Lord Derby Challenge Trophy', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Apr', year:'Senior', name:'Antares Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Late Apr',  year:'Senior', name:'Tenno Sho (Spring)', grade:'G1', distance:'Long', track:'Turf'},
  {date:'Late Apr',  year:'Senior', name:'Milers Cup (Yomiuri)', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Late Apr',  year:'Senior', name:'Fukushima Umamusume Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early May', year:'Senior', name:'Victoria Mile', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Early May', year:'Senior', name:'Keio Hai Spring Cup', grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early May', year:'Senior', name:'Niigata Daishoten', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late May',  year:'Senior', name:'Meguro Kinen', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Late May',  year:'Senior', name:'Heian Stakes', grade:'G3', distance:'Medium', track:'Dirt'},
  {date:'Early Jun', year:'Senior', name:'Yasuda Kinen', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Early Jun', year:'Senior', name:'Naruo Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jun', year:'Senior', name:'Mermaid Stakes', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jun', year:'Senior', name:'Epsom Cup', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Jun',  year:'Senior', name:'Teio Sho', grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Late Jun',  year:'Senior', name:'Takarazuka Kinen', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Jun',  year:'Senior', name:'Hakodate Sprint Stakes', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Senior', name:'CBC Sho', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Jul', year:'Senior', name:'Procyon Stakes', grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Jul', year:'Senior', name:'Tanabata Sho', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Jul', year:'Senior', name:'Hakodate Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Jul',  year:'Senior', name:'Chukyo Kinen', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Jul',  year:'Senior', name:'Ibis Summer Dash', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Jul',  year:'Senior', name:'Queen Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Aug', year:'Senior', name:'Kokura Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Aug', year:'Senior', name:'Sekiya Kinen', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Early Aug', year:'Senior', name:'Elm Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Late Aug',  year:'Senior', name:'Sapporo Kinen', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Aug',  year:'Senior', name:'Kitakyushu Kinen', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Late Aug',  year:'Senior', name:'Keeneland Cup', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Senior', name:'Centaur Stakes', grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Early Sep', year:'Senior', name:'Niigata Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Sep', year:'Senior', name:'Keisei Hai Autumn Handicap', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Sep',  year:'Senior', name:'Sprinters Stakes', grade:'G1', distance:'Sprint', track:'Turf'},
  {date:'Late Sep',  year:'Senior', name:'All Comers', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Late Sep',  year:'Senior', name:'Sirius Stakes', grade:'G3', distance:'Medium', track:'Dirt'},
  {date:'Early Oct', year:'Senior', name:'Kyoto Daishoten', grade:'G2', distance:'Medium', track:'Turf'},
  {date:'Early Oct', year:'Senior', name:'Mainichi Okan', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Oct', year:'Senior', name:'Fuchu Umamusume Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Late Oct',  year:'Senior', name:'Tenno Sho (Autumn)', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Oct',  year:'Senior', name:'Swan Stakes', grade:'G2', distance:'Sprint', track:'Turf'},
  {date:'Late Oct',  year:'Senior', name:'Fuji Stakes', grade:'G2', distance:'Mile', track:'Turf'},
  {date:'Early Nov', year:'Senior', name:'JBC Classic', grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'JBC Sprint', grade:'G1', distance:'Sprint', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:"JBC Ladies' Classic", grade:'G1', distance:'Mile', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'Queen Elizabeth II Cup', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Early Nov', year:'Senior', name:'Copa Republica Argentina', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Early Nov', year:'Senior', name:'Miyako Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'Musashino Stakes', grade:'G3', distance:'Mile', track:'Dirt'},
  {date:'Early Nov', year:'Senior', name:'Fukushima Kinen', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Senior', name:'Japan Cup', grade:'G1', distance:'Medium', track:'Turf'},
  {date:'Late Nov',  year:'Senior', name:'Mile Championship', grade:'G1', distance:'Mile', track:'Turf'},
  {date:'Late Nov',  year:'Senior', name:'Keihan Hai', grade:'G3', distance:'Sprint', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Champions Cup', grade:'G1', distance:'Mile', track:'Dirt'},
  {date:'Early Dec', year:'Senior', name:'Stayers Stakes', grade:'G2', distance:'Long', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Challenge Cup', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Chunichi Shimbun Hai', grade:'G3', distance:'Medium', track:'Turf'},
  {date:'Early Dec', year:'Senior', name:'Capella Stakes', grade:'G3', distance:'Sprint', track:'Dirt'},
  {date:'Early Dec', year:'Senior', name:'Turquoise Stakes', grade:'G3', distance:'Mile', track:'Turf'},
  {date:'Late Dec',  year:'Senior', name:'Tokyo Daishoten', grade:'G1', distance:'Medium', track:'Dirt'},
  {date:'Late Dec',  year:'Senior', name:'Arima Kinen', grade:'G1', distance:'Long', track:'Turf'},
  {date:'Late Dec',  year:'Senior', name:'Hanshin Cup', grade:'G2', distance:'Sprint', track:'Turf'},

  // ===== EX: 3 (Scenario) =====
  {date:'Scenario', year:'EX', name:'URA Finale Qualifier', grade:'EX', distance:'Medium', track:'Turf'},
  {date:'Scenario', year:'EX', name:'URA Finale Semifinal', grade:'EX', distance:'Medium', track:'Turf'},
  {date:'Scenario', year:'EX', name:'URA Finale Finals', grade:'EX', distance:'Medium', track:'Turf'}
];

/* ===== Crowns (sentence case titles) ===== */
const CROWNS = [
  {id:'classic_triple', title:'Classic Triple Crown', keys:[
    "Classic__Early Apr__Satsuki Sho",
    "Classic__Late May__Japanese Derby (Tokyo Yushun)",
    "Classic__Late Oct__Kikuka Sho"
  ]},
  {id:'triple_tiara', title:'Triple Tiara', keys:[
    "Classic__Early Apr__Oka Sho",
    "Classic__Late May__Japanese Oaks",
    "Classic__Late Oct__Shuka Sho"
  ]},
  {id:'spring_triple', title:'Senior Spring Triple Crown', keys:[
    "Senior__Late Mar__Osaka Hai",
    "Senior__Late Apr__Tenno Sho (Spring)",
    "Senior__Late Jun__Takarazuka Kinen"
  ]},
  {id:'autumn_triple', title:'Senior Autumn Triple Crown', keys:[
    "Senior__Late Oct__Tenno Sho (Autumn)",
    "Senior__Late Nov__Japan Cup",
    "Senior__Late Dec__Arima Kinen"
  ]},
  {id:'dual_gp', title:'Dual Grand Prix', keys:[
    "Senior__Late Jun__Takarazuka Kinen",
    "Senior__Late Dec__Arima Kinen"
  ]},
  {id:'dual_miles', title:'Dual Miles', keys:[
    "Senior__Early Jun__Yasuda Kinen",
    "Senior__Late Nov__Mile Championship"
  ]},
  {id:'dual_sprints', title:'Dual Sprints', keys:[
    "Senior__Late Mar__Takamatsunomiya Kinen",
    "Senior__Late Sep__Sprinters Stakes"
  ]},
  {id:'dual_dirts', title:'Dual Dirts', keys:[
    "Senior__Late Feb__February Stakes",
    "Senior__Early Dec__Champions Cup"
  ]}
];

/* ===== State & storage ===== */
const DEFAULT_UMA=["Special Week","Silence Suzuka","Tokai Teio","Vodka","Daiwa Scarlet","Gold Ship","Mejiro McQueen","Symboli Rudolf","Rice Shower","Taiki Shuttle","Narita Brian","Agnes Tachyon","Hishi Amazon","El Condor Pasa","Manhattan Cafe","Haru Urara"];
function blankInfo(){return{
  photo:null,
  careerKeys:[],
  track:{turf:"A",dirt:"A"},
  distance:{sprint:"A",mile:"A",medium:"A",long:"A"},
  pace:{front:"A",chaser:"A",late:"A",end:"A"},     // NEW
  supports:[], altSupports:[], deckNote:"", skills:[],
  focusKeys:[]
};}
const state={umaList:loadUmaList(), currentUma:null, sortKey:"year", sortDir:1, view:"all"};

function loadUmaList(){
  const raw=localStorage.getItem("umamusume.umalist"); let list=raw?JSON.parse(raw):{};
  if(!raw || Object.keys(list).length===0){
    list={}; for(const n of DEFAULT_UMA){ list[n]={results:{},tags:"",info:blankInfo()}; }
    localStorage.setItem("umamusume.umalist",JSON.stringify(list));
  }
  for(const k of Object.keys(list)){
    const i=list[k].info||{};
    list[k].info={...blankInfo(),...i};
    list[k].info.supports=(list[k].info.supports||[]).filter(s=>s && s.name);
    list[k].info.altSupports=(list[k].info.altSupports||[]).filter(s=>s && s.name);
    list[k].info.skills=(list[k].info.skills||[]).filter(Boolean);
    list[k].info.focusKeys=(list[k].info.focusKeys||[]).filter(validKey);
    list[k].info.careerKeys=(list[k].info.careerKeys||[]).filter(validKey);
  }
  if(!localStorage.getItem("umamusume.migr.clearCrowns.v2")){
    for(const k of Object.keys(list)){ list[k].info.focusKeys=[]; }
    localStorage.setItem("umamusume.migr.clearCrowns.v2","1");
  }
  return list;
}
function saveUmaList(){ localStorage.setItem("umamusume.umalist",JSON.stringify(state.umaList)); }

/* ===== Helpers ===== */
const MONTH_ORDER=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function posIndex(pos){return pos==='Early'?1:pos==='Mid'?2:pos==='Late'?3:2;}
function parseDateStr(s){const [pos,mon]=s.trim().split(/\s+/);return{m:MONTH_ORDER.indexOf(mon),p:posIndex(pos||'Mid')};}
function sortByYearThenCalendar(a,b,dir){
  const order={Junior:1,Classic:2,Senior:3,EX:4};
  const y=(order[a.year]||0)-(order[b.year]||0);
  if(y!==0) return dir*y;
  const A=parseDateStr(a.date),B=parseDateStr(b.date);
  if(A.m!==B.m)return dir*(A.m-B.m);
  if(A.p!==B.p)return dir*(A.p-B.p);
  return dir*a.name.localeCompare(b.name);
}
function raceKey(r){return `${r.year}__${r.date}__${r.name}`;}
function validKey(k){return !!RACES.find(r=>raceKey(r)===k);}
function findRaceByKey(k){return RACES.find(r=>raceKey(r)===k);}
function textMatch(r,q){return (`${r.year} ${r.date} ${r.name} ${r.grade} ${r.distance} ${r.track}`.toLowerCase()).includes(q.toLowerCase());}
function getCheckedValues(el){return [...el.querySelectorAll("input:checked")].map(cb=>cb.value);}
function inCareer(u,key){const info=state.umaList[u]?.info; return !!info && (info.careerKeys||[]).includes(key);}

/* ===== UI refs ===== */
const umaSelect=document.getElementById("umaSelect");
const dashGrades=document.getElementById("dashGrades");
const dashTracks=document.getElementById("dashTracks");
const dashDistances=document.getElementById("dashDistances");
const dashYears=document.getElementById("dashYears");
const searchBox=document.getElementById("searchBox");
const clearFiltersBtn=document.getElementById("clearFilters");
const raceTBody=document.querySelector("#raceTable tbody");
const statTotal=document.getElementById("statTotal");
const statWins=document.getElementById("statWins");
const statLosses=document.getElementById("statLosses");
const viewBadge=document.getElementById("viewBadge");
const viewGroup=document.getElementById("viewGroup");
const thName=document.querySelector('th[data-sort="name"]');
const thYear=document.querySelector('th[data-sort="year"]');
const sortNameInd=document.getElementById("sortName");
const sortYearInd=document.getElementById("sortYear");
const crownList=document.getElementById("crownList");
const umaPhotoEl=document.getElementById("umaPhoto");
const photoDialog=document.getElementById("photoDialog");
const photoLarge=document.getElementById("photoLarge");
const photoClose=document.getElementById("photoClose");
const photoInput=document.getElementById("photoInput");
const photoRemoveBtn=document.getElementById("photoRemoveBtn");
const editInfoBtn=document.getElementById("editInfoBtn");
const infoEditor=document.getElementById("infoEditor");
const careerConfirm=document.getElementById("careerConfirm");

/* ===== Export/Import/Clear ===== */
document.getElementById("exportJson").onclick=()=>{
  const data={version:36,umaList:state.umaList};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="umamusume_race_progress.json";a.click();
};
document.getElementById("importJsonBtn").onclick=()=>document.getElementById("importFile").click();
document.getElementById("importFile").addEventListener("change",e=>{
  const f=e.target.files?.[0];if(!f)return;
  const fr=new FileReader();
  fr.onload=()=>{try{
      const d=JSON.parse(fr.result);
      if(d.umaList) localStorage.setItem("umamusume.umalist",JSON.stringify(d.umaList));
      state.umaList=loadUmaList();initUmaSelect();buildCrownUI();clearSort();render();alert("Import complete.");
    }catch{alert("Import failed. Invalid file.");}};
  fr.readAsText(f);
});
document.getElementById("clearUmaData").onclick=()=>{
  const u=state.currentUma;if(!u)return;
  if(confirm("Clear all data for "+u+"?")){
    state.umaList[u]={results:{},tags:"",info:blankInfo()};
    saveUmaList();initUmaSelect();buildCrownUI();render();
  }
};
document.getElementById("resetMarks").onclick=()=>{
  const u=state.currentUma;if(!u)return;
  if(confirm("Reset all Win and Loss marks for "+u+"?")){
    state.umaList[u].results={};saveUmaList();render();
  }
};

/* ===== Photo viewer ===== */
umaPhotoEl.addEventListener("click",()=>{
  const u=state.currentUma;if(!u)return;
  const src=state.umaList[u].info.photo;if(!src)return;
  photoLarge.src=src;
  (photoDialog.showModal?photoDialog.showModal():photoDialog.setAttribute('open','open'));
});
photoClose.onclick=()=> (photoDialog.close?photoDialog.close():photoDialog.removeAttribute('open'));

/* ===== Photo upload/remove ===== */
photoInput?.addEventListener("change",(e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const u=state.currentUma || Object.keys(state.umaList)[0]; if(!u) return;
  const fr=new FileReader();
  fr.onload=()=>{
    const info=state.umaList[u].info||blankInfo();
    info.photo=fr.result;
    state.umaList[u].info=info;
    saveUmaList();
    render();
    alert("Photo saved.");
  };
  fr.readAsDataURL(file);
});
photoRemoveBtn?.addEventListener("click",()=>{
  const u=state.currentUma;if(!u) return;
  const info=state.umaList[u].info||blankInfo();
  info.photo=null;
  state.umaList[u].info=info;
  saveUmaList();
  render();
});

/* ===== View switching ===== */
viewGroup.addEventListener("change",(e)=>{
  if(e.target.name==="view"){
    state.view=e.target.value;
    render();
  }
});

/* ===== Sorting ===== */
thName.addEventListener("click",()=>toggleSort("name"));
thYear.addEventListener("click",()=>toggleSort("year"));
function toggleSort(key){
  if(state.sortKey===key){state.sortDir=-state.sortDir;}
  else{state.sortKey=key;state.sortDir=1;}
  updateSortIndicators();render();
}
function clearSort(){state.sortKey="year";state.sortDir=1;updateSortIndicators();}
function updateSortIndicators(){
  sortNameInd.textContent=(state.sortKey==="name"?(state.sortDir>0?"▲":"▼"):"");
  sortYearInd.textContent=(state.sortKey==="year"?(state.sortDir>0?"▲":"▼"):"▲");
}

/* ===== Filters / search ===== */
[...document.querySelectorAll('#dashGrades input,#dashTracks input,#dashDistances input,#dashYears input')].forEach(el=>el.addEventListener("change", render));
searchBox.oninput=render;
document.getElementById("clearEligibility").onclick=()=>{ render(); };
clearFiltersBtn.onclick=()=>{
  [dashGrades,dashTracks,dashDistances,dashYears].forEach(el=>el.querySelectorAll("input").forEach(cb=>cb.checked=false));
  searchBox.value=""; clearSort(); render();
};

/* ===== Calendar ===== */
function renderCalendar(races){
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML="";
  const buckets=new Map();
  for(const r of races){
    const [pos, mon]=r.date.split(' ');
    const month=mon||r.date;
    if(!buckets.has(month)) buckets.set(month,[]);
    buckets.get(month).push(r);
  }
  const monthOrder=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Scenario'];
  for(const mon of monthOrder){
    const list=buckets.get(mon)||[];
    if(!list.length) continue;
    const box=document.createElement('div');
    box.className='box';
    box.innerHTML=`<div class="subtle" style="margin-bottom:6px">${mon}</div>`;
    list.sort((a,b)=>sortByYearThenCalendar(a,b,1));
    for(const r of list){
      const key=raceKey(r);
      const a=document.createElement('a');
      a.href="#";
      a.textContent=r.name;
      a.className='race-link';
      a.dataset.key=key;
      a.addEventListener('click', (ev)=>{ ev.preventDefault(); openRacePopover(r, ev); });
      const meta=document.createElement('div');
      meta.className='subtle';
      const u=state.currentUma; const isCareer = inCareer(u,key);
      meta.innerHTML=`${r.year} • ${r.grade} • ${r.distance} • ${r.track} ${isCareer?'<span class="pill small">Career race</span>':''}`;
      box.appendChild(a); box.appendChild(meta);
    }
    grid.appendChild(box);
  }
}

/* ===== Popover ===== */
const pop=document.getElementById('racePopover');
const popTitle=document.getElementById('popTitle');
const popMeta=document.getElementById('popMeta');
const popBtn=document.getElementById('popPrimaryBtn');
const popClose=document.getElementById('popCloseBtn');

function openRacePopover(r, ev){
  const key=raceKey(r), u=state.currentUma;
  popTitle.textContent=r.name;
  popMeta.textContent=`${r.year} • ${r.grade} • ${r.distance} • ${r.track}`;
  const isCareer=inCareer(u,key);
  popBtn.textContent=isCareer?'Remove from Career':'Add to Career';
  popBtn.onclick=()=>{
    if(isCareer){ removeFromCareer(key); } else { addRaceToCareer(key); }
    showCareerConfirm();
    hidePopover();
  };
  pop.style.left = Math.min(ev.clientX+12, window.innerWidth-360)+'px';
  pop.style.top  = Math.min(ev.clientY+12, window.innerHeight-180)+'px';
  pop.style.display='block';
  setTimeout(()=> document.addEventListener('click', outsideClose), 0);
}
function hidePopover(){ pop.style.display='none'; document.removeEventListener('click', outsideClose); }
function outsideClose(e){ if(!pop.contains(e.target)) hidePopover(); }
pop.addEventListener('click',e=>e.stopPropagation());
popClose.addEventListener('click', hidePopover);

/* ===== Career dialog ===== */
function showCareerConfirm(){
  const box=document.getElementById('careerListBox');
  const u=state.currentUma; const info=state.umaList[u].info||blankInfo();
  const keys=(info.careerKeys||[]).filter(validKey);
  if(!keys.length){ box.innerHTML='<div class="empty">No races in career.</div>'; }
  else{
    box.innerHTML='';
    for(const k of keys){
      const r=findRaceByKey(k);
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=`<div><strong>${r.name}</strong><div class="subtle">${r.year} • ${r.date} • ${r.grade} • ${r.distance} • ${r.track}</div></div>
      <button class="delbtn slim" data-key="${k}">Remove</button>`;
      box.appendChild(row);
    }
    box.querySelectorAll('.delbtn').forEach(b=>b.addEventListener('click',()=>{
      removeFromCareer(b.dataset.key); showCareerConfirm();
    }));
  }
  (careerConfirm.showModal?careerConfirm.showModal():careerConfirm.setAttribute('open','open'));
}
document.getElementById('careerClose').onclick=()=> (careerConfirm.close?careerConfirm.close():careerConfirm.removeAttribute('open'));

/* ===== Career ops ===== */
function addRaceToCareer(key){
  if(!validKey(key)) return;
  const u=state.currentUma;if(!u) return;
  const info = state.umaList[u].info || blankInfo();
  if(!info.careerKeys.includes(key)) info.careerKeys.push(key);
  info.careerKeys = (info.careerKeys||[]).filter(validKey);
  state.umaList[u].info = info;
  saveUmaList();
  render();
}
function removeFromCareer(key){
  const u=state.currentUma;if(!u)return;
  const info=state.umaList[u].info||blankInfo();
  info.careerKeys = (info.careerKeys||[]).filter(k=>k!==key);
  state.umaList[u].info=info; saveUmaList(); render();
}

/* ===== Crown UI ===== */
function buildCrownUI(){
  crownList.innerHTML="";
  const u=state.currentUma;if(!u) return;
  const focusSet=new Set(state.umaList[u].info.focusKeys||[]);
  CROWNS.forEach(c=>{
    const label=document.createElement("label"); const id="crown_"+c.id;
    label.htmlFor=id; label.innerHTML=`<input type="checkbox" id="${id}"> ${c.title}`;
    const cb=label.querySelector("input");
    const keys=c.keys.filter(validKey);
    const allOn=keys.length>0 && keys.every(k=>focusSet.has(k));
    const someOn=!allOn && keys.some(k=>focusSet.has(k));
    cb.checked=allOn; cb.indeterminate=someOn;
    cb.addEventListener("change",()=>{
      const set=new Set(state.umaList[state.currentUma].info.focusKeys||[]);
      if(cb.checked){keys.forEach(k=>set.add(k));} else {keys.forEach(k=>set.delete(k));}
      state.umaList[state.currentUma].info.focusKeys=Array.from(set).filter(validKey);
      saveUmaList(); buildCrownUI(); render();
    });
    crownList.appendChild(label);
  });
}

/* ===== Editor widgets ===== */
const ranks=['S','A','B','C','D','E','F','G'];
const typeOptions=['SPD','STAM','PWR','GUTS','WIT'];

function fillSelectOpts(sel,vals,cur){ sel.innerHTML=''; vals.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v; if(v===cur) o.selected=true; sel.appendChild(o);});}
function supportRow({type='',name=''}, removable=false){
  const wrap=document.createElement('div'); wrap.className='flex sup-row';
  const sel=document.createElement('select'); typeOptions.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t; if(t===type) o.selected=true; sel.appendChild(o);});
  const inp=document.createElement('input'); inp.placeholder='Card name'; inp.value=name||'';
  wrap.appendChild(sel); wrap.appendChild(inp);
  if(removable){ const del=document.createElement('button'); del.className='delbtn'; del.textContent='Remove'; del.onclick=()=>wrap.remove(); wrap.appendChild(del); }
  return wrap;
}
function skillRow(v=''){
  const d=document.createElement('div'); d.className='skill-row';
  const i=document.createElement('input'); i.placeholder='Skill name'; i.value=v||'';
  const del=document.createElement('button'); del.className='delbtn'; del.textContent='Remove'; del.onclick=()=>d.remove();
  d.appendChild(i); d.appendChild(del);
  return d;
}

editInfoBtn.addEventListener('click', ()=>{
  const u=state.currentUma;if(!u) return;
  const inf=state.umaList[u].info||blankInfo();

  fillSelectOpts(document.getElementById('editTurf'), ranks, inf.track.turf);
  fillSelectOpts(document.getElementById('editDirt'), ranks, inf.track.dirt);
  fillSelectOpts(document.getElementById('editSprint'), ranks, inf.distance.sprint);
  fillSelectOpts(document.getElementById('editMile'), ranks, inf.distance.mile);
  fillSelectOpts(document.getElementById('editMedium'), ranks, inf.distance.medium);
  fillSelectOpts(document.getElementById('editLong'), ranks, inf.distance.long);

  /* NEW: Pace aptitude selects */
  fillSelectOpts(document.getElementById('editPaceFront'),  ranks, (inf.pace&&inf.pace.front)||'A');
  fillSelectOpts(document.getElementById('editPaceChaser'), ranks, (inf.pace&&inf.pace.chaser)||'A');
  fillSelectOpts(document.getElementById('editPaceLate'),   ranks, (inf.pace&&inf.pace.late)||'A');
  fillSelectOpts(document.getElementById('editPaceEnd'),    ranks, (inf.pace&&inf.pace.end)||'A');

  const supWrap=document.getElementById('editSupports'); supWrap.innerHTML='';
  const six=(inf.supports&&inf.supports.length?inf.supports:[{},{},{},{},{},{}]).slice(0,6);
  while(six.length<6) six.push({});
  six.forEach(s=>supWrap.appendChild(supportRow(s,false)));

  const altWrap=document.getElementById('editAltSupports'); altWrap.innerHTML='';
  (inf.altSupports||[]).forEach(s=>altWrap.appendChild(supportRow(s,true)));
  document.getElementById('addAltSupport').onclick=()=> altWrap.appendChild(supportRow({type:'SPD',name:''},true));

  const skillWrap=document.getElementById('editSkills'); skillWrap.innerHTML='';
  (inf.skills||[]).forEach(sk=>skillWrap.appendChild(skillRow(sk)));
  document.getElementById('addSkill').onclick=()=> skillWrap.appendChild(skillRow(''));

  document.getElementById('editDeckNote').value=inf.deckNote||'';

  (infoEditor.showModal?infoEditor.showModal():infoEditor.setAttribute('open','open'));
});

document.getElementById('infoClose').onclick=()=> (infoEditor.close?infoEditor.close():infoEditor.removeAttribute('open'));
document.getElementById('infoSave').onclick=()=>{
  const u=state.currentUma;if(!u)return;
  const info=state.umaList[u].info||blankInfo();
  info.track.turf=document.getElementById('editTurf').value;
  info.track.dirt=document.getElementById('editDirt').value;
  info.distance.sprint=document.getElementById('editSprint').value;
  info.distance.mile=document.getElementById('editMile').value;
  info.distance.medium=document.getElementById('editMedium').value;
  info.distance.long=document.getElementById('editLong').value;

  /* NEW: save pace aptitude */
  info.pace = info.pace || {front:'A',chaser:'A',late:'A',end:'A'};
  info.pace.front  = document.getElementById('editPaceFront').value;
  info.pace.chaser = document.getElementById('editPaceChaser').value;
  info.pace.late   = document.getElementById('editPaceLate').value;
  info.pace.end    = document.getElementById('editPaceEnd').value;

  const supRows=[...document.querySelectorAll('#editSupports .sup-row')];
  info.supports=supRows.map(r=>({type:r.querySelector('select').value, name:r.querySelector('input').value.trim()})).filter(x=>x.name);
  const altRows=[...document.querySelectorAll('#editAltSupports .sup-row')];
  info.altSupports=altRows.map(r=>({type:r.querySelector('select').value, name:r.querySelector('input').value.trim()})).filter(x=>x.name);
  const skillRows=[...document.querySelectorAll('#editSkills .skill-row')];
  info.skills=skillRows.map(r=>r.querySelector('input').value.trim()).filter(Boolean);
  info.deckNote=document.getElementById('editDeckNote').value;

  state.umaList[u].info=info; saveUmaList(); render();
  (infoEditor.close?infoEditor.close():infoEditor.removeAttribute('open'));
};

/* ===== Render ===== */
function initUmaSelect(){
  const sel=document.getElementById("umaSelect");
  sel.innerHTML="";
  const names=Object.keys(state.umaList).sort();
  for(const n of names){const opt=document.createElement("option");opt.value=n;opt.textContent=n;sel.appendChild(opt);}
  const addOpt=document.createElement("option"); addOpt.value="__add__"; addOpt.textContent="+ Add new"; sel.appendChild(addOpt);
  sel.addEventListener("change", ()=>{
    if(sel.value==="__add__"){
      const name=prompt("Enter Umamusume name");
      if(name && !state.umaList[name]){state.umaList[name]={results:{},tags:"",info:blankInfo()};saveUmaList();initUmaSelect();sel.value=name;}
      else sel.value=state.currentUma||Object.keys(state.umaList)[0];
    }
    state.currentUma=sel.value;
    render();
  });
  state.currentUma = state.currentUma || names[0] || null;
}

function applyDashFilters(list){
  const gs=getCheckedValues(dashGrades), ts=getCheckedValues(dashTracks), ds=getCheckedValues(dashDistances), ys=getCheckedValues(dashYears);
  const q=searchBox.value.trim();
  return list.filter(r =>
    (!gs.length || gs.includes(r.grade)) &&
    (!ts.length || ts.includes(r.track)) &&
    (!ds.length || ds.includes(r.distance)) &&
    (!ys.length || ys.includes(r.year)) &&
    (!q || textMatch(r,q))
  );
}
function recommendedMatches(inf, r){
  const tOK = (r.track==='Turf' && (inf.track.turf==='S'||inf.track.turf==='A')) ||
              (r.track==='Dirt' && (inf.track.dirt==='S'||inf.track.dirt==='A'));
  const dOK = (r.distance==='Sprint' && (inf.distance.sprint==='S'||inf.distance.sprint==='A')) ||
              (r.distance==='Mile'   && (inf.distance.mile==='S'||inf.distance.mile==='A')) ||
              (r.distance==='Medium' && (inf.distance.medium==='S'||inf.distance.medium==='A')) ||
              (r.distance==='Long'   && (inf.distance.long==='S'||inf.distance.long==='A'));
  return tOK && dOK;
}

function render(){
  if(!state.currentUma){state.currentUma=Object.keys(state.umaList)[0]||"Special Week";}
  const inf=state.umaList[state.currentUma].info||blankInfo();

  // sanitize
  inf.supports=(inf.supports||[]).filter(s=>s && s.name);
  inf.altSupports=(inf.altSupports||[]).filter(s=>s && s.name);
  inf.skills=(inf.skills||[]).filter(Boolean);

  // Photo
  if(inf.photo){ umaPhotoEl.src=inf.photo; umaPhotoEl.style.display='block'; }
  else{ umaPhotoEl.removeAttribute('src'); umaPhotoEl.style.display='none'; }

  // Details
  document.getElementById("infoTrack").textContent=`Turf ${inf.track.turf}, Dirt ${inf.track.dirt}`;
  document.getElementById("infoAptitude").textContent=`Sprint ${inf.distance.sprint}, Mile ${inf.distance.mile}, Medium ${inf.distance.medium}, Long ${inf.distance.long}`;
  document.getElementById("infoPace").textContent=`Front runner ${inf.pace.front}, Pace chaser ${inf.pace.chaser}, Late surger ${inf.pace.late}, End closer ${inf.pace.end}`;

  const supUL=document.getElementById('infoSupports'); supUL.innerHTML='';
  if(inf.supports.length){ inf.supports.forEach(s=>{const li=document.createElement('li'); li.textContent=`${s.type}: ${s.name}`; supUL.appendChild(li);}); }
  else supUL.innerHTML='<li>None</li>';
  document.getElementById('supportsWarn').style.display=(inf.supports.length===6)?'none':'block';

  const altUL=document.getElementById('infoAltSupports'); altUL.innerHTML='';
  if(inf.altSupports.length){ inf.altSupports.forEach(s=>{const li=document.createElement('li'); li.textContent=`${s.type}: ${s.name}`; altUL.appendChild(li);}); }
  else altUL.innerHTML='<li>None</li>';
  document.getElementById('infoDeckNote').textContent=inf.deckNote||'None';

  const skillsUL=document.getElementById('infoSkills'); skillsUL.innerHTML='';
  if(inf.skills.length){ inf.skills.forEach(sk=>{const li=document.createElement('li'); li.textContent=sk; skillsUL.appendChild(li);}); }
  else skillsUL.innerHTML='<li>None</li>';

  // View selection
  const checkedRadio=document.querySelector('#viewGroup input[name="view"]:checked');
  state.view = checkedRadio ? checkedRadio.value : state.view || "all";
  const v=state.view;
  document.getElementById("calendarWrap").style.display = (v==='calendar')?'grid':'none';
  document.getElementById("raceTable").style.display = (v==='calendar')?'none':'table';
  document.getElementById("viewBadge").textContent = v==='all'?'All races':(v.charAt(0).toUpperCase()+v.slice(1));

  // Build list
  let base = RACES.slice();
  if(v==='recommended'){
    base = applyDashFilters(base.filter(r=>recommendedMatches(inf,r)));
  } else if(v==='career'){
    const keys=(inf.careerKeys||[]).filter(validKey);
    base = applyDashFilters(keys.map(findRaceByKey).filter(Boolean));
  } else if(v==='calendar'){
    const cal = applyDashFilters(RACES.slice());
    renderCalendar(cal.sort((a,b)=>sortByYearThenCalendar(a,b,1)));
    updateStats(cal);
    return;
  } else if(v==='all'){
    base = applyDashFilters(base);
  }

  // Sort
  if(state.sortKey==='name') base.sort((a,b)=> state.sortDir * a.name.localeCompare(b.name));
  else base.sort((a,b)=> sortByYearThenCalendar(a,b,state.sortDir));

  // Rows
  const results=state.umaList[state.currentUma].results||{};
  const focusSet=new Set((inf.focusKeys||[]).filter(validKey));
  raceTBody.innerHTML="";
  for(const r of base){
    const key=raceKey(r); const res=results[key]||"";
    const tr=document.createElement("tr"); const classes=[];
    if(res==="win") classes.push("win"); else if(res==="loss") classes.push("loss");
    if(focusSet.has(key)) classes.push("focus");
    tr.className=classes.join(" ");
    const isCareer=inCareer(state.currentUma,key);
    const actionBtn=(v==='career')
      ? `<button class="iconbtn remove-career" data-key="${key}">Remove</button>`
      : `<button class="iconbtn add-career" data-key="${key}">${isCareer?'In career':'Add to career'}</button>`;
    tr.innerHTML=`
      <td>${r.date}</td>
      <td>${r.name}</td>
      <td>(${r.grade}, ${r.distance}, ${r.track})</td>
      <td>${r.year}</td>
      <td>
        <select data-key="${key}">
          <option value="">Not set</option>
          <option value="win"${res==="win"?" selected":""}>Win</option>
          <option value="loss"${res==="loss"?" selected":""}>Loss</option>
        </select>
        <div class="inline-actions" style="margin-top:6px">${actionBtn}</div>
      </td>`;
    raceTBody.appendChild(tr);
  }
  raceTBody.querySelectorAll("select").forEach(sel=>{
    sel.addEventListener("change", e=>{
      const key=e.target.dataset.key, val=e.target.value;
      if(val) state.umaList[state.currentUma].results[key]=val; else delete state.umaList[state.currentUma].results[key];
      saveUmaList(); render();
    });
  });
  raceTBody.querySelectorAll(".add-career").forEach(btn=>{
    btn.addEventListener("click", ()=> { addRaceToCareer(btn.dataset.key); showCareerConfirm(); });
  });
  raceTBody.querySelectorAll(".remove-career").forEach(btn=>{
    btn.addEventListener("click", ()=> { removeFromCareer(btn.dataset.key); showCareerConfirm(); });
  });

  updateStats(base);
  buildCrownUI();
}

function updateStats(view){
  const results=state.umaList[state.currentUma]?.results||{};
  let wins=0, losses=0;
  for(const r of view){const k=raceKey(r); if(results[k]==='win') wins++; else if(results[k]==='loss') losses++; }
  statTotal.textContent=view.length; statWins.textContent=wins; statLosses.textContent=losses;
}

/* ===== Boot ===== */
(function boot(){
  initUmaSelect();
  updateSortIndicators();
  render();
})();
</script>
</body>
</html>
